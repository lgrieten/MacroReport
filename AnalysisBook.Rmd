---
title: "Measurement analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())

if(!require(prettydoc)) install.packages('prettydoc')
if(!require(readxl)) install.packages('readxl')
if(!require(knitr)) install.packages('knitr')
if(!require(kableExtra)) install.packages('kableExtra')
if(!require(ggplot2)) install.packages('ggplot2')
if(!require(glue)) install.packages('glue')
if(!require(scales)) install.packages('scales')
if(!require(lubridate)) install.packages('lubridate')
if(!require(highcharter)) install.packages('highcharter')
if(!require(knitr)) install.packages('knitr')
if(!require(data.table)) install.packages('data.table')
if(!require(plyr)) install.packages('plyr')
if(!require(dplyr)) install.packages('dplyr')
if(!require(formattable)) install.packages('formattable')
if(!require(tidyr)) install.packages('tidyr')
if(!require(rmarkdown)) install.packages('rmarkdown')
if(!require(DT)) install.packages('DT')
if(!require(eeptools)) install.packages('eeptools')
if(!require(varhandle)) install.packages('varhandle')
if(!require(tidyverse)) install.packages('tidyverse')
if(!require(reshape)) install.packages('reshape')
if(!require(scales)) install.packages('scales')
if(!require(svDialogs)) install.packages('svDialogs')


library(scales)
library(reshape)
library(tidyverse)
library(varhandle)
library(prettydoc)
library(readxl)
library(knitr)
library(kableExtra)
library(ggplot2)
library(glue)
library(scales)
library(lubridate)
library(highcharter)
library(rmarkdown)
library(formattable)
library(tidyr)
library(dplyr)
library(data.table)
library(tidyverse)
library(DT)
library(eeptools)
library(svDialogs)
```

```{r input variables, echo=FALSE}
#configure input variables
    path <- file.path("/Volumes/GoogleDrive/Shared drives/9. Clinical/9.6 Data reporting/BHRUT/Final analysis pilot")
    #seperator for the CSV files, this can be ";" or "," 
    ssep = ";"
    users_file <- file.path(path,"users.csv")
    profiles_file<- file.path(path,"profiles.csv")
    measurements_file<- file.path(path,"measurements.csv")
    prescriptions_file <- file.path(path,"prescriptions.csv")

#import source files
    setwd(path)
    user_data <- read.csv(users_file, sep=ssep)
    profile <- read.csv(profiles_file, sep=ssep)
    measurments <- read.csv(measurements_file, sep=ssep)
    prescriptions <- read.csv(prescriptions_file, sep=ssep)

#import source files
expected_measurements_per_day <- 2

#inner join files
meas_prof_file <- inner_join(measurments,profile, by = c('userIds.0'='id'))
```

```{r cleanup users that are not eligible, echo=FALSE}
#DELETE USERS FROM THE FRAME?
delete_users<- c("5ef45ff846e0fb0007fde259","5bf40e5fcff47e0008eb42ae","58074800b2148f3b28ad7590", "5eb1457c4cedfd0006d7a28f", "5db06b8bd6018000069f77ee", "5dc02e7fd6018000069f7be6", "5d39d099c9e77c0006b25ce5","5d808a40c9e77c00089a7846")
user_data = filter(user_data, !(id %in% delete_users))
profile = filter(profile, !(id %in% delete_users))
measurments = filter(measurments, !(userIds.0 %in% delete_users))
prescriptions = filter(prescriptions, !(user_id %in% delete_users))
```


```{r Population metrics, echo=FALSE, message=FALSE}
# NUMBER OF PARTICIPANTS
number_of_participants <- nrow(user_data)

#CONVERT BIRTHDAY TO DATE
profile$birthday <-as.Date(profile$birthday,format = "%Y-%m-%d")

# AVERAGE AGE
average_age <-
    profile %>%
    select(gender, birthday) %>%
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days')/365))%>%
    group_by(gender)%>%
    summarise(avg_age = mean(age))%>%
    filter(between(gender, 1, 4))%>%
    ungroup()%>%
    summarise(round(mean(avg_age)))%>%.[[1]]
average_age <- glue::glue('{average_age} years')


# PERCENTAGE MEN
percentage_men <- scales::percent(sum(profile$gender == 1) / number_of_participants)

# TOTAL NUMBER OF MEASUREMENTS 
total_number_of_measurements <- nrow(measurments)

# MEDIAN NUMBER OF MEASUREMENTS / PARTICIPANT 
median_number_of_measurements_per_participant <-
    measurments %>% 
    group_by(userIds.0)%>%
    summarise(freq=n_distinct(id)) %>% 
    ungroup() %>% 
    summarise(round(median(freq),0)) %>% .[[1]]

# Measurement freauency calculation
frequency_of_measurements <-
    measurments %>% 
    group_by(userIds.0) %>%     
    summarise(freq=n_distinct(id))

frequency_of_measurements_freq<- as.factor(frequency_of_measurements$freq) 
freq <-as.data.frame(table(frequency_of_measurements_freq))
p55 <- 
    highchart() %>% 
    hc_title(text = "Measurement distribution") %>% 
    hc_chart(type = "column") %>% 
    hc_xAxis(categories = freq$frequency_of_measurements_freq, title = list("test")) %>%
    hc_add_series(data = freq$Freq, color='#8BD8DB', name='Age groups') %>%
    hc_tooltip(pointFormat = "{point.y}%",crosshairs = TRUE, shared = TRUE) %>% 
    hc_legend(enabled = T) %>% 
    hc_size(width = 400,height = 300)


# AVERAGE NUMBER OF PARTICIPANT 
avg_number_of_measurements_per_participant <-
    measurments %>% 
    group_by(userIds.0) %>% 
    summarise(freq=n_distinct(id)) %>% 
    ungroup() %>% 
    summarise(round(mean(freq),0)) %>% .[[1]]

# TABULATE FINDINGS PER ARRHYTHMIA ON MEASUREMENT LEVEL
arrhythmia_table <-
      measurments %>% 
    group_by(data.diagnosis.label.0) %>%     
    summarise(freq=n_distinct(id)) %>%
    mutate(fraction=round((freq/sum(freq))*100,1))%>%
    arrange(-freq)
names(arrhythmia_table)[names(arrhythmia_table) == "data.diagnosis.label.0"] <- "Heart rhythm"
names(arrhythmia_table)[names(arrhythmia_table) == "freq"] <- "Frequency"
names(arrhythmia_table)[names(arrhythmia_table) == "fraction"] <- "%"

   
# TABULATE MEASUREMENT ATTEMPTS PER USER AND MEASUREMENT
  meas_attempt_user <-
  measurments %>%
  group_by(userIds.0, data.attempts) %>%
  #summarise(mean=mean(data.attempts))%>%
  #summarise(sd=sd(data.attempts, na.rm=TRUE))
  summarise(freq=n_distinct(id))

names(meas_attempt_user)[names(meas_attempt_user) == "data.attempts"] <- "Measurement attempts"
names(meas_attempt_user)[names(meas_attempt_user) == "freq"] <- "Frequency"    


# PEOPLE WITHOUT ATRIAL FIBRILLATION (AF)
people_no_disorders <-
     measurments %>% 
        filter(data.diagnosis.label.0 %in% c('sinus','increased_hrv')) %>% 
        summarise(n_distinct(userIds.0)) %>% .[[1]] 
people_no_disorders <- (people_no_disorders/number_of_participants)*100


# PEOPLE WITH ATRIAL FIBRILLATION (AF)
people_with_atrial_fibrillation <-
    measurments %>% 
        filter(data.diagnosis.label.0 %in% c('atrial_fibrillation','atrial_flutter')) %>% 
        summarise(n_distinct(userIds.0)) %>% .[[1]]

people_with_atrial_fibrillation_pct <- (people_with_atrial_fibrillation/number_of_participants)*100

# PEOPLE WITH OTHER CARDIAC ARRHYTHMIAS    
people_with_other_cardiac_arrhythmias <- 
    measurments %>% 
        filter(data.indicator %in% c('warning')) %>% 
        summarise(n_distinct(userIds.0)) %>% .[[1]]
people_with_other_cardiac_arrhythmias_pct <- (people_with_other_cardiac_arrhythmias/number_of_participants)*100

#Range of people with disorders

people_with_atrial_fibrillation <-
    measurments %>% 
    filter(data.diagnosis.label.0 %in% c('atrial_fibrillation','atrial_flutter')) %>% 
  summarise(n_distinct(userIds.0)) %>% .[[1]]

  arrhythmia_per_user <- cast(measurments, userIds.0 ~ data.diagnosis.label.0)
  

# TOTAL NUMBER OF HEARTBEATS REGISTERED
total_number_of_heartbeats_registered <- sum(measurments$data.heartrate, na.rm=TRUE)

rbind(`Number of participants` = glue::glue('{scales::comma(number_of_participants)} subjects')
      ,`Average age` = average_age
      ,`Percentage men` = percentage_men
      ,`Total number of measurements` = scales::comma(total_number_of_measurements)
      ,`Median number of measurements / participant` = median_number_of_measurements_per_participant
      ,`Average number of measurements / participant` = avg_number_of_measurements_per_participant
      ,`People with atrial fibrillation (AF)` = glue::glue('{people_with_atrial_fibrillation} ({round(people_with_atrial_fibrillation_pct,1)}%)') 
      ,`People with other cardiac arrhythmia's` = glue::glue('{people_with_other_cardiac_arrhythmias} ({round(people_with_other_cardiac_arrhythmias_pct,1)}%)') 
      ,`Total number of heartbeats registered` =  scales::comma(total_number_of_heartbeats_registered)) %>% 
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14
    ) 


```
# Demography calculations
## Gender distribution

```{r demograpy calculations, echo=FALSE}
plot_left_1_df <-
    profile %>% 
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days'))
           ,age = age / 365
           ,gender=ifelse(gender==1,'male','female')) %>% 
    group_by(gender) %>% 
    summarise(cnt=n()
              ,avg=mean(age)
              ,oldest=max(age)
              )


ggplot(plot_left_1_df, aes(x="", y=cnt, fill=gender)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +  theme_void() 

rbind(`Percentage men:` = percentage_men
      ,`Avg age man:` = round(plot_left_1_df[plot_left_1_df$gender=='male',][['avg']],1)
      ,`Avg age women:` = round(plot_left_1_df[plot_left_1_df$gender!='male',][['avg']],1)
      ,`Oldest male participant:` = round(plot_left_1_df[plot_left_1_df$gender=='male',][['oldest']],1)
      ,`Oldest female participant:` = round(plot_left_1_df[plot_left_1_df$gender!='male',][['oldest']],1)
      ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)
```

## Age distribution

```{r echo=FALSE}
plot_right_1_df <-
    profile %>% 
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days'))
           ,age = age / 365
           ,age = ifelse(age<20,'<20'
                 ,ifelse(age<30,'20-30'
                 ,ifelse(age<40,'30-40'
                 ,ifelse(age<50,'40-50'
                 ,ifelse(age<60,'50-60'
                 ,ifelse(age<70,'60-70','70-80'))))))) %>% 
    group_by(age) %>% 
    summarise(cnt=n()) %>% 
    ungroup %>% 
    mutate(cnt_=round(cnt/sum(cnt)*100,1)
           ,cnt__=round(cnt/sum(cnt),2)
           )

ggplot(plot_right_1_df, aes(x=age, y=cnt, fill="#F8766D")) +
  geom_bar(stat="identity")+theme_minimal() + theme(legend.position = "none")

rbind(`Total number of participants:` = number_of_participants
      ,`Average age:` = average_age
      ,`Participants >40 years:` = scales::percent(sum(plot_right_1_df$cnt__[plot_right_1_df$age %in% c('40-50','50-60','60-70','70-80')]))
      ,`Participants >60 years :` = scales::percent(sum(plot_right_1_df$cnt__[plot_right_1_df$age %in% c('60-70','70-80')])
      )) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)

```
## Country distribution

```{r Country Analysis, echo=FALSE}
plot_country_total <-
  profile %>% 
  group_by(country) %>%
  summarise(freq=n_distinct(id))%>%
  mutate(cnt_=(freq/sum(freq)), cnt__=round(cnt_*100,1))
  names(plot_country_total)[names(plot_country_total) == "cnt__"] <- "Percentage" 
  plot_country <- plot_country_total[ c("country", "Percentage")]
  
  ggplot(plot_country_total, aes(x="", y=freq, fill=country)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +  theme_void() 
  
most_popular_country <- as.vector(plot_country_total%>% 
        arrange(-cnt_) %>%
        head(1) %>%
        .[[1]])
    
tot_countries <- nrow(plot_country_total)


rbind(`Country with most users:`= most_popular_country,`Total countries:` = tot_countries )%>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)

```
## Phone distribution

```{r Phone analysis, echo=FALSE}

plot_right_2_df <-     
        profile %>% 
        select(fibricheck_info.device.manufacturer) %>% 
        group_by(device=fibricheck_info.device.manufacturer) %>% 
        summarise(cnt=n()) %>% 
        ungroup %>% 
        mutate(cnt_=round(cnt/sum(cnt)*100,1)
               ,cnt__=round(cnt/sum(cnt),2)) %>% 
        arrange(-cnt) %>% 
        group_by(device) %>% 
        summarise(cnt=sum(cnt)) %>% 
        ungroup %>% 
        mutate(cnt_=round(cnt/sum(cnt)*100,1)
               ,cnt__=round(cnt/sum(cnt),2)) %>% 
        arrange(-cnt)


  ggplot(plot_right_2_df, aes(x="", y=cnt__, fill=device)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +  theme_void() 


most_popular_device <- as.vector(plot_right_2_df%>% 
        arrange(-cnt) %>%
        head(1) %>%
        .[[1]])

perc_ios <- plot_right_2_df%>% 
        filter(tolower(device)=='apple') %>% 
        mutate(cnt__=scales::percent(cnt__)) %>% 
        .[[4]]

insufficient_quality <- scales::percent(round((nrow(filter(measurments, data.indicator == "quality"))/total_number_of_measurements),2))

rbind(`Most popular device:`= most_popular_device,`Percentage iOS:` = perc_ios, `Percentage insufficient quality:` = insufficient_quality)%>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)
```
# Medical History


```{r, message=FALSE, echo=FALSE}

#list of people with AF
list_user_id_AF <- 
  measurments%>%
  filter(data.diagnosis.label.0 == "atrial_fibrillation") %>%
  group_by(userIds.0)%>%
  summarise(n_distinct(userIds.0))%>%
  select(userIds.0)%>%
  as.vector()

#MEDICAL HISTORY PROFILE total

medical_history<-
      profile[c("id","gender","birthday", "custom_fields.arrhythmias", "custom_fields.atrialFibrillationKnowledge", "custom_fields.arrhythmias", "custom_fields.heartFailure", "custom_fields.arteryDisease", "custom_fields.atrialFibrillation", "custom_fields.stroke", "custom_fields.hypertension", "custom_fields.diabetes", "custom_fields.bloodThinner")] %>%
      mutate(age = round(age_calc(birthday, units = "years"))) 

      data <- as.matrix(medical_history)
      data[which(data == "false")] <- "0"
      data[which(data == "true")] <- "1"
      data <-as.data.frame(data)
      
      #data$custom_fields.arrhythmias <-as.numeric(data$custom_fields.arrhythmias)

      data$custom_fields.atrialFibrillationKnowledge <-as.numeric(data$custom_fields.atrialFibrillationKnowledge)
      data$custom_fields.heartFailure<-as.numeric(data$custom_fields.heartFailure)
      data$custom_fields.arteryDisease<-as.numeric(data$custom_fields.arteryDisease)
      data$custom_fields.atrialFibrillation<-as.numeric(data$custom_fields.atrialFibrillation)
      data$custom_fields.stroke<-as.numeric(data$custom_fields.stroke)
      data$custom_fields.hypertension<-as.numeric(data$custom_fields.hypertension)
      data$custom_fields.diabetes<-as.numeric(data$custom_fields.diabetes)
      data$custom_fields.bloodThinner <-as.numeric(data$custom_fields.bloodThinner)
      data$age <-as.numeric(data$age)
      data$gender <-as.numeric(data$gender)

      blank_rows <- sum(rowSums(is.na(data))>2)
      filled_in <-nrow(data)-blank_rows    
      
      
      AF_knowledge <- sum(data$custom_fields.atrialFibrillationKnowledge, na.rm=TRUE)
      HF <- sum(data$custom_fields.heartFailure, na.rm=TRUE)
      AD <-sum(data$custom_fields.arteryDisease, na.rm=TRUE)
      AF_history <-sum(data$custom_fields.atrialFibrillation, na.rm=TRUE)
      stroke <- sum( data$custom_fields.stroke, na.rm=TRUE)
      hypertension<- sum(data$custom_fields.hypertension, na.rm=TRUE)
      diabetes<- sum(data$custom_fields.diabetes, na.rm=TRUE)
      bloodthinner<- sum(data$custom_fields.bloodThinner, na.rm=TRUE)
      blank_rows <- sum(rowSums(is.na(data))>2)
      filled_in <-nrow(data)-blank_rows    
      
      History.df <- data.frame(AF_knowledge,HF,AD,AF_history,stroke,hypertension,diabetes,bloodthinner) 
      
# AF PATIENTS
medical_history_af<-
      profile[c("id","gender","birthday", "custom_fields.arrhythmias", "custom_fields.atrialFibrillationKnowledge", "custom_fields.arrhythmias", "custom_fields.heartFailure", "custom_fields.arteryDisease", "custom_fields.atrialFibrillation", "custom_fields.stroke", "custom_fields.hypertension", "custom_fields.diabetes", "custom_fields.bloodThinner")] %>%
      mutate(age = round(age_calc(birthday, units = "years"))) 

medical_history_af_2 <- filter(medical_history_af, (id %in% list_user_id_AF$userIds.0))

      data_af <- as.matrix(medical_history_af_2)
      data_af[which(data_af == "false")] <- "0"
      data_af[which(data_af == "true")] <- "1"
      data_af <-as.data.frame(data_af)
      
      #data$custom_fields.arrhythmias <-as.numeric(data$custom_fields.arrhythmias)

      data_af$custom_fields.atrialFibrillationKnowledge <-as.numeric(data_af$custom_fields.atrialFibrillationKnowledge)
      data_af$custom_fields.heartFailure<-as.numeric(data_af$custom_fields.heartFailure)
      data_af$custom_fields.arteryDisease<-as.numeric(data_af$custom_fields.arteryDisease)
      data_af$custom_fields.atrialFibrillation<-as.numeric(data_af$custom_fields.atrialFibrillation)
      data_af$custom_fields.stroke<-as.numeric(data_af$custom_fields.stroke)
      data_af$custom_fields.hypertension<-as.numeric(data_af$custom_fields.hypertension)
      data_af$custom_fields.diabetes<-as.numeric(data_af$custom_fields.diabetes)
      data_af$custom_fields.bloodThinner <-as.numeric(data_af$custom_fields.bloodThinner)
      data_af$age <-as.numeric(data_af$age)
      data_af$gender <-as.numeric(data_af$gender)

      blank_rows_af <- sum(rowSums(is.na(data_af))>2)
      filled_in <-nrow(data_af)-blank_rows_af    
      
      
      AF_knowledge_af <- sum(data_af$custom_fields.atrialFibrillationKnowledge, na.rm=TRUE)
      HF_af <- sum(data_af$custom_fields.heartFailure, na.rm=TRUE)
      AD_af <-sum(data_af$custom_fields.arteryDisease, na.rm=TRUE)
      AF_history_af <-sum(data_af$custom_fields.atrialFibrillation, na.rm=TRUE)
      stroke_af <- sum( data_af$custom_fields.stroke, na.rm=TRUE)
      hypertension_af<- sum(data_af$custom_fields.hypertension, na.rm=TRUE)
      diabetes_af<- sum(data_af$custom_fields.diabetes, na.rm=TRUE)
      bloodthinner_af<- sum(data_af$custom_fields.bloodThinner, na.rm=TRUE)
      blank_rows_af <- sum(rowSums(is.na(data_af))>2)
      filled_in_af <-nrow(data_af)-blank_rows_af    
      
      

rbind(` Total` = paste("(",nrow(profile),")"),
      ` History of Heart Failure` = HF,
      ` History of Diabetes` = diabetes,
      ` History of Artery Disease` = AD,
      ` History of AF` = AF_history,
      ` History of hypertension` = hypertension,
      ` History of Stroke` = stroke,
      `Already takes a bloodthinner` = bloodthinner,
      `Amount of filled in questionnaires` = filled_in,
      `Amount of blank questionnaires` = blank_rows,
      ` AF patients` = paste("(",nrow(list_user_id_AF),")","/","(",nrow(profile),")"),
      ` History of Heart Failure` = HF_af,
      ` History of Diabetes` = diabetes,
      ` History of Artery Disease` = AD_af,
      ` History of AF` = AF_history_af,
      ` History of hypertension` = hypertension_af,
      ` History of Stroke` = stroke_af,
      `Already takes a bloodthinner` = bloodthinner_af,
      `Amount of filled in questionnaires` = filled_in_af,
      `Amount of blank questionnaires` = blank_rows_af
      ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = T,
        font_size = 14)
```

```{r}
plot_left_2_df <-     
    prescriptions %>% 
        select(paid_timestamp) %>% 
          mutate(date=as.POSIXct((paid_timestamp/1000) ,origin = "1970-01-01 00:00:00:000")) %>% 
        group_by(date=as.Date(date)) %>% 
        summarise(cnt=n()) %>% 
        ungroup %>% 
        mutate(cnt_=round(cnt/sum(cnt)*100,1)
              ,cnt__=round(cnt/sum(cnt),2))

ggplot(plot_left_2_df, aes(x=date, y=cnt, fill="#F8766D")) +
  geom_bar(stat="identity")+theme_minimal() + theme(legend.position = "none")

```
```{r}
peck_hour <- 
    prescriptions %>% 
    select(paid_timestamp) %>% 
    ## https://www.freeformatter.com/epoch-timestamp-to-date-converter.html
    mutate(hour=hour(as.POSIXct((paid_timestamp/1000) ,origin = "1970-01-01 00:00:00:000"))) %>% 
    group_by(hour) %>% 
    summarise(cnt=n()) %>% 
    arrange(-cnt) %>% head(1) %>% .[[1]]
    
rbind(`Peak activation - day:` = as.character(as.Date(plot_left_2_df %>% arrange(-cnt) %>% head(1) %>% .[[1]],origin='1970-01-01'))
      ,`Peak activation - Time (UTC):` = peck_hour
      ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = T,
        font_size = 14)
```

```{r warning=FALSE, message=FALSE, echo=FALSE}
plot_left_3_df <- 
    measurments %>% 
    select(creationTimestamp) %>% 
    mutate(date=as.Date(creationTimestamp)) %>% 
    group_by(w=week(date)) %>% 
    summarise(cnt=n()
              ,min_date=min(date)
              ,max_date=max(date)) %>% 
    ungroup() %>% 
    mutate(cnt_=round(cnt/sum(cnt)*100,1)
           ,cnt__=round(cnt/sum(cnt),2)) %>% 
    arrange(w) %>% 
    mutate(min_date=paste(day(min_date),month(min_date),sep='/')
           ,max_date=paste(day(max_date),month(max_date),sep='/')
           ,wd=paste(min_date,max_date,sep='-'))

ggplot(plot_left_3_df, aes(x=wd, y=cnt_, fill="#F8766D")) +
  geom_bar(stat="identity")+theme_minimal() + theme(legend.position = "none", axis.text.x = element_text(angle = 30))    


plot_right_3_df <- 
    measurments %>% 
    select(creationTimestamp) %>% 
    mutate(hour=hour(ymd_hms(creationTimestamp))
          ,hour_=ifelse(hour<2,'0-2 AM',
                ifelse(hour<4,'2-4 AM',
                ifelse(hour<6,'4-6 AM',
                ifelse(hour<8,'6-8 AM',
                ifelse(hour<10,'8-10 AM',
                ifelse(hour<12,'10-12 AM',
                ifelse(hour<14,'12-2 PM',
                ifelse(hour<16,'2-4 PM',
                ifelse(hour<18,'4-6 PM',
                ifelse(hour<20,'6-8 PM',
                ifelse(hour<22,'8-10 PM','10-12 PM')))))))))))) %>% 
    group_by(hour_) %>% 
    summarise(cnt=n(),min_hour=min(hour)) %>% 
    arrange(min_hour) 

ggplot(plot_right_3_df, aes(x=hour_, y=cnt, fill="#F8766D")) +
  geom_bar(stat="identity")+theme_minimal() + theme(legend.position = "none") +
  scale_x_discrete(limits=plot_right_3_df$hour_)
```

```{r, message=FALSE, echo=FALSE}
max_measures_per_day <- 
    measurments %>% 
    select(creationTimestamp) %>% 
    mutate(date=as.Date(creationTimestamp)) %>% 
    group_by(date) %>% 
    summarise(cnt=n()) %>% 
    ungroup() %>% 
    summarise(max(cnt)) %>% .[[1]]
rbind(`Peak measurements (UTC): ` = plot_right_3_df %>% 
        arrange(-cnt) %>% 
        head(1) %>% 
        .[[1]]
      ,`Total number of measurements received:` = total_number_of_measurements
      ,`Max number of tot. measurements / day:` = max_measures_per_day
      ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = T,
        font_size = 14)
```

```{r warning=FALSE, message=FALSE, echo=FALSE}

compliance_plot <-
  measurments %>%
  group_by(userIds.0) %>%
  summarise(freq=n_distinct(id))%>% 
  mutate(cnt_=(freq/m_per_day/duration), cnt__=round(cnt_*100), compliance = ifelse(cnt__<10,'<10%'
                                     ,ifelse(cnt__<20,'10%-20%'
                                             ,ifelse(cnt__<30,'20%-30%'
                                                     ,ifelse(cnt__<40,'30%-40%'
                                                             ,ifelse(cnt__<50,'40%-50%'
                                                                      ,ifelse(cnt__<60,'50%-60%'
                                                                               ,ifelse(cnt__<70,'60%-70%'
                                                                                        ,ifelse(cnt__<80,'70%-80%'
                                                                                                 ,ifelse(cnt__<90,'80%-90%'
                                                                                                          ,ifelse(cnt__<100,'90%-100%'
                                                                                                                   ,ifelse(cnt__<150,'b 100% -150%'
                                                                                                                           ,ifelse(cnt__<200,'b 150%-200%'
                                                                                                                                   ,ifelse(cnt__>200,'more then 200%',"/"))))))))))))))                                                                                                                                                        

compliance_plot_total<-
    compliance_plot %>%
    group_by(compliance) %>%
    summarise(cnt=n())
 
p <- 
    highchart() %>% 
      hc_xAxis(categories = compliance_plot_total$compliance) %>%
   # hc_yAxis_multiples(
    #    list(lineWidth = 3),
     #   list(showLastLabel = FALSE, opposite = T)) %>%
    hc_title(text = "Average amount of measurements") %>% 
    hc_add_series(data = compliance_plot_total$cnt,type="column",color='#8BD8DB',name='Avg num of measurements') %>% 
    #hc_add_series(data = plot_right_4_df$cnt_, type = "spline", yAxis = 1,name='% participants',color='lightgray') %>% 
    hc_tooltip(crosshairs = TRUE) %>%
    hc_legend(enabled = F) %>% 
    hc_size(width = 400,height = 350)




plot_right_4_df_a <-
    profile %>% 
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days'))
           ,age = age / 365
           ,age = ifelse(age<20,'<20'
                         ,ifelse(age<30,'20-30'
                                 ,ifelse(age<40,'30-40'
                                         ,ifelse(age<50,'40-50'
                                                 ,ifelse(age<60,'50-60'
                                                         ,ifelse(age<70,'60-70','70-80'))))))) %>% 
    group_by(age) %>% 
    summarise(cnt=n()) %>%
    ungroup %>% 
    mutate(cnt_=round(cnt/sum(cnt)*100,1)
           ,cnt__=round(cnt/sum(cnt),1)
    )


plot_right_4_df_b <-
    inner_join(measurments,profile,by = c('creatorId'='id')) %>% 
    select(birthday,id,creatorId) %>% 
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days'))
           ,age = age / 365
           ,age = ifelse(age<20,'<20'
                         ,ifelse(age<30,'20-30'
                                 ,ifelse(age<40,'30-40'
                                         ,ifelse(age<50,'40-50'
                                                 ,ifelse(age<60,'50-60'
                                                         ,ifelse(age<70,'60-70','70-80'))))))) %>% 
    group_by(age) %>% 
    summarise(per_user_cnt=round(n()/n_distinct(creatorId))) 

plot_right_4_df <- inner_join(plot_right_4_df_a,plot_right_4_df_b)

p1 <- 
    highchart() %>% 
      hc_xAxis(categories = plot_right_1_df$age) %>%
    #hc_yAxis_multiples(
     #   list(lineWidth = 3),
     #   list(showLastLabel = FALSE, opposite = T)) %>%
    hc_title(text = "Average Number of Measurements per Age") %>% 
    hc_add_series(data = plot_right_4_df$per_user_cnt,type="column",color='#8BD8DB',name='Avg num of measurements') %>% 
    #hc_add_series(data = plot_right_4_df$cnt_, type = "spline", yAxis = 1,name='% participants',color='lightgray') %>% 
    hc_tooltip(crosshairs = TRUE) %>%
    hc_legend(enabled = F) %>% 
    hc_size(width = 400,height = 300)