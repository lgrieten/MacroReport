---
title: "Your experience with FibriCheck"
author: "Fibricheck"
date: "25/12/2021"
#output:  html_document
output: 
   ioslides_presentation:
    widescreen: true
    logo: logo_wp.png
    css: slidestyles2.css
runtime: shiny
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE) 

if(!require(prettydoc)) install.packages('prettydoc')
if(!require(readxl)) install.packages('readxl')
if(!require(knitr)) install.packages('knitr')
if(!require(kableExtra)) install.packages('kableExtra')
if(!require(ggplot2)) install.packages('ggplot2')
if(!require(glue)) install.packages('glue')
if(!require(scales)) install.packages('scales')
if(!require(lubridate)) install.packages('lubridate')
if(!require(highcharter)) install.packages('highcharter')
if(!require(knitr)) install.packages('knitr')
if(!require(data.table)) install.packages('data.table')
if(!require(plyr)) install.packages('plyr')
if(!require(dplyr)) install.packages('dplyr')
if(!require(formattable)) install.packages('formattable')
if(!require(tidyr)) install.packages('tidyr')
if(!require(rmarkdown)) install.packages('rmarkdown')
if(!require(DT)) install.packages('DT')
if(!require(eeptools)) install.packages('eeptools')
if(!require(varhandle)) install.packages('varhandle')
if(!require(tidyverse)) install.packages('tidyverse')
if(!require(reshape)) install.packages('reshape')
if(!require(scales)) install.packages('scales')
if(!require(svDialogs)) install.packages('svDialogs')
if(!require(readxl)) install.packages('readxl')
if(!require(devtools)) install.packages('devtools')
if(!require(rCharts))  devtools::install_github('ramnathv/rCharts')

library(readxl) # for reading xlsx files
library(rCharts) # for sankeyPlot
library(scales)
library(reshape)
library(tidyverse)
library(varhandle)
library(prettydoc)
library(readxl)
library(knitr)
library(kableExtra)
library(ggplot2)
library(ggpubr)
library(glue)
library(scales)
library(lubridate)
library(highcharter)
library(rmarkdown)
library(formattable)
library(tidyr)
library(dplyr)
library(data.table)
library(tidyverse)
library(DT)
library(eeptools)
library(svDialogs)
library(knitr)

```

```{r function builder,  eval= TRUE, message=FALSE, include= FALSE}
#build functions:
get_sankey_plot <- function(df, min_num_users, max_num_steps, width, height, save=F, file_name) {
        df_ <-
            df %>%
            filter(cnt >= min_num_users, to <= max_num_steps) %>% 
            mutate(
                source = paste0(from, "_", type),
                target = paste0(to, "_", next_type),
                value = cnt
            ) %>%
            select(source, target, value)
        
        sankeyPlot <- rCharts$new()
        sankeyPlot$setLib('http://timelyportfolio.github.io/rCharts_d3_sankey')
        sankeyPlot$setTemplate(
            afterScript = "
            <script>
            var colors = {};
            d3.selectAll(' svg .node')[0].forEach(function(n) {
            type = n.getElementsByTagName('text')[0].innerHTML.replace(/[0-9]/g, '');
            if (typeof(colors[type]) == 'undefined') {
            colors[type] = n.getElementsByTagName('rect')[0].style.fill;
            } else {
            n.getElementsByTagName('rect')[0].style.fill = colors[type] ;
            };
            });
            
            d3.selectAll('svg path.link')
            .style('stroke', function(d){
            return d.source.color;
            })
            //.style('stroke-opacity', .7)
            </script>
            "
        )
        
        sankeyPlot$set(
            data = df_,
            nodePadding = 30,
            layout = 32,
            fontsize = 1,
            nodeWidth = 30,
            width = width,
            height = height,
            units = "users",
            title = "Sankey Diagram"
        )
        if(save) sankeyPlot$save(file.path(file_name))
        return(sankeyPlot)
    }
```

```{r input variables, echo=FALSE}
#configure input variables
    path <- file.path("/Volumes/GoogleDrive/Shared drives/9. Clinical/9.6 Data reporting/Hannover")
    #seperator for the CSV files, this can be ";" or "," 
    ssep = ";"
    #users_file <- file.path(path,"users.csv")
    profiles_file<- file.path(path,"profiles.csv")
    measurements_file<- file.path(path,"measurements.csv")
    prescriptions_file <- file.path(path,"prescriptions.csv")

#import source files
    setwd(path)
    #user_data <- read.csv(users_file, sep=ssep)
    profile <- read.csv(profiles_file, sep=ssep)
    measurments <- read.csv(measurements_file, sep=ssep)
    prescriptions <- read.csv(prescriptions_file, sep=ssep)

#import source files
m_per_day <- 4
duration <- 30
Today <- as.Date("2021-12-07")

#inner join files
meas_prof_file <- inner_join(measurments,profile, by = c('userIds.0'='id'))

#Unique USER ID'S
UserID <- unique(profile$id)
```

```{r cleanup users that are not eligible, echo=FALSE}
#DELETE USERS FROM THE FRAME?
delete_users<- c("5ef45ff846e0fb0007fde259","5bf40e5fcff47e0008eb42ae","58074800b2148f3b28ad7590", "5eb1457c4cedfd0006d7a28f", "5db06b8bd6018000069f77ee", "5dc02e7fd6018000069f7be6", "5d39d099c9e77c0006b25ce5","5d808a40c9e77c00089a7846","580747d1b2148f3b28ad7586")
#user_data = filter(user_data, !(id %in% delete_users))
profile = filter(profile, !(id %in% delete_users))
measurments = filter(measurments, !(userIds.0 %in% delete_users))
prescriptions = filter(prescriptions, !(user_id %in% delete_users))
Users_ID <- profile$id
```

```{r load prescriptions dataset, eval = TRUE, echo=FALSE, message=FALSE}
#load dataset of prescriptions
groups <- read.csv("/Volumes/GoogleDrive/Shared drives/9. Clinical/9.6 Data reporting/20211202_groups.csv", sep=",")
database_prescriptions <- read.csv("/Volumes/GoogleDrive/Shared drives/9. Clinical/9.6 Data reporting/20211202_database prescriptions.csv", sep=";")
#database_prescriptions_filtered = filter(database_prescriptions, (user_id %in% Users_ID))
database_prescriptions_filtered = filter(database_prescriptions, (status == "ACTIVATED"))

# merge the 2 files by group id
data_sankey_prescriptions <- inner_join(database_prescriptions_filtered, groups, by = c('group_id' = 'id'))
```

```{r create new fields in the datasets, echo=FALSE}
prescriptions$dur <- round(prescriptions$duration/1000/60/60/24)
```

```{r include=FALSE}
unique(measurments$data.context.symptoms.0)
table(measurments$data.context.symptoms.0)
measurments$data.context.symptoms.0 = as.character(measurments$data.context.symptoms.0)
for(i in 1:nrow(measurments))
{
  if(measurments$data.context.symptoms.0[i] == "no_symptoms")
  {
    measurments$data.context.symptoms.sym[i]= "0"
  }
  else if(measurments$data.context.symptoms.0[i] == "palpitations")
  {
    measurments$data.context.symptoms.sym[i]= "1"
  }
  else if(measurments$data.context.symptoms.0[i] == "fatigue")
  {
    measurments$data.context.symptoms.sym[i]= "1"
  }
  else if(measurments$data.context.symptoms.0[i] == "shortness_of_breath")
  {
    measurments$data.context.symptoms.sym[i]= "1"
  }
  else if(measurments$data.context.symptoms.0[i] == "lightheaded")
  {
    measurments$data.context.symptoms.sym[i]= "1"
  }
  else if(measurments$data.context.symptoms.0[i] == "other")
  {
    measurments$data.context.symptoms.sym[i]= "1"
  }
  else if(measurments$data.context.symptoms.0[i] == "Confused")
  {
    measurments$data.context.symptoms.sym[i]= "1"
  }
  else if(measurments$data.context.symptoms.0[i] == "chest_pains")
  {
    measurments$data.context.symptoms.sym[i]= "1"
  }
  else
  {
    measurments$data.context.symptoms.sym[i]="NA"
  }
}
```

## Disclaimer
- All data generated here is pseudominized
- All data is based on patient generated data, the measurements, symptoms, demographics and medical history
- This report is designed to give you an insight on the entire population you manage with FibriCheck. 

## High level data overview
The following table shows general metrics calculated out of your dataset. 

```{r Population metrics, echo=FALSE, message=FALSE}
# NUMBER OF PARTICIPANTS
number_of_participants <- nrow(profile)

#CONVERT BIRTHDAY TO DATE
profile$birthday <-as.Date(profile$birthday,format = "%Y-%m-%d")

# AVERAGE AGE
average_age <-
    profile %>%
    select(gender, birthday) %>%
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days')/365))%>%
    group_by(gender)%>%
    summarise(avg_age = mean(age))%>%
    filter(between(gender, 1, 4))%>%
    ungroup()%>%
    summarise(round(mean(avg_age)))%>%.[[1]]
average_age <- glue::glue('{average_age} years')


# PERCENTAGE MEN
percentage_men <- scales::percent(sum(profile$gender == 1) / number_of_participants)

# TOTAL NUMBER OF MEASUREMENTS 
total_number_of_measurements <- nrow(measurments)

# MEDIAN NUMBER OF MEASUREMENTS / PARTICIPANT 
median_number_of_measurements_per_participant <-
    measurments %>% 
    group_by(userIds.0)%>%
    summarise(freq=n_distinct(id)) %>% 
    ungroup() %>% 
    summarise(round(median(freq),0)) %>% .[[1]]

# Measurement freauency calculation
frequency_of_measurements <-
    measurments %>% 
    group_by(userIds.0) %>%     
    summarise(freq=n_distinct(id))

frequency_of_measurements_freq<- as.factor(frequency_of_measurements$freq) 
freq <-as.data.frame(table(frequency_of_measurements_freq))
p55 <- 
    highchart() %>% 
    hc_title(text = "Measurement distribution") %>% 
    hc_chart(type = "column") %>% 
    hc_xAxis(categories = freq$frequency_of_measurements_freq, title = list("test")) %>%
    hc_add_series(data = freq$Freq, color='#8BD8DB', name='Age groups') %>%
    hc_tooltip(pointFormat = "{point.y}%",crosshairs = TRUE, shared = TRUE) %>% 
    hc_legend(enabled = T) %>% 
    hc_size(width = 400,height = 300)


# AVERAGE NUMBER OF PARTICIPANT 
avg_number_of_measurements_per_participant <-
    measurments %>% 
    group_by(userIds.0) %>% 
    summarise(freq=n_distinct(id)) %>% 
    ungroup() %>% 
    summarise(round(mean(freq),0)) %>% .[[1]]

# people without measurements 
people_without_measurements <- nrow(profile) - n_distinct(measurments$userIds.0)

# TABULATE FINDINGS PER ARRHYTHMIA ON MEASUREMENT LEVEL
arrhythmia_table <-
      measurments %>% 
    group_by(data.diagnosis.label.0) %>%     
    summarise(freq=n_distinct(id)) %>%
    mutate(fraction=round((freq/sum(freq))*100,1))%>%
    arrange(-freq)
names(arrhythmia_table)[names(arrhythmia_table) == "data.diagnosis.label.0"] <- "Heart rhythm"
names(arrhythmia_table)[names(arrhythmia_table) == "freq"] <- "Frequency"
names(arrhythmia_table)[names(arrhythmia_table) == "fraction"] <- "%"

   
# TABULATE MEASUREMENT ATTEMPTS PER USER AND MEASUREMENT
  meas_attempt_user <-
  measurments %>%
  group_by(userIds.0, data.attempts) %>%
  #summarise(mean=mean(data.attempts))%>%
  #summarise(sd=sd(data.attempts, na.rm=TRUE))
  summarise(freq=n_distinct(id))

names(meas_attempt_user)[names(meas_attempt_user) == "data.attempts"] <- "Measurement attempts"
names(meas_attempt_user)[names(meas_attempt_user) == "freq"] <- "Frequency"    


# PEOPLE WITHOUT ATRIAL FIBRILLATION (AF)
people_no_disorders <-
     measurments %>% 
        filter(data.diagnosis.label.0 %in% c('sinus','increased_hrv')) %>% 
        summarise(n_distinct(userIds.0)) %>% .[[1]] 
people_no_disorders <- (people_no_disorders/number_of_participants)*100


# PEOPLE WITH ATRIAL FIBRILLATION (AF)
people_with_atrial_fibrillation <-
    measurments %>% 
        filter(data.diagnosis.label.0 %in% c('atrial_fibrillation','atrial_flutter')) %>% 
        summarise(n_distinct(userIds.0)) %>% .[[1]]

people_with_atrial_fibrillation_pct <- (people_with_atrial_fibrillation/number_of_participants)*100

# PEOPLE WITH OTHER CARDIAC ARRHYTHMIAS    
people_with_other_cardiac_arrhythmias <- 
    measurments %>% 
        filter(data.indicator %in% c('warning')) %>% 
        summarise(n_distinct(userIds.0)) %>% .[[1]]
people_with_other_cardiac_arrhythmias_pct <- (people_with_other_cardiac_arrhythmias/number_of_participants)*100

#Range of people with disorders

people_with_atrial_fibrillation <-
    measurments %>% 
    filter(data.diagnosis.label.0 %in% c('atrial_fibrillation','atrial_flutter')) %>% 
  summarise(n_distinct(userIds.0)) %>% .[[1]]

  arrhythmia_per_user <- cast(measurments, userIds.0 ~ data.diagnosis.label.0)
  

# TOTAL NUMBER OF HEARTBEATS REGISTERED
total_number_of_heartbeats_registered <- sum(measurments$data.heartrate, na.rm=TRUE)

rbind(`Number of participants` = glue::glue('{scales::comma(number_of_participants)} subjects')
      ,`Average age` = average_age
      ,`Percentage men` = percentage_men
      ,`Total number of measurements` = scales::comma(total_number_of_measurements)
      ,`Median number of measurements / participant` = median_number_of_measurements_per_participant
      ,`Average number of measurements / participant` = avg_number_of_measurements_per_participant
      ,`People with atrial fibrillation (AF)` = glue::glue('{people_with_atrial_fibrillation} ({round(people_with_atrial_fibrillation_pct,1)}%)') 
      ,`People with other cardiac arrhythmia's` = glue::glue('{people_with_other_cardiac_arrhythmias} ({round(people_with_other_cardiac_arrhythmias_pct,1)}%)') 
      ,`Total number of heartbeats registered` =  scales::comma(total_number_of_heartbeats_registered)
      ,`Number of people without measurements` = people_without_measurements)%>% 
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14,
        ) 


```

## Demography calculations 
Distribution of genders

<div style="float: left; width: 60%;">

```{r}
plot_left_1_df <-
    profile %>% 
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days'))
           ,age = age / 365
           ,gender=ifelse(gender==1,'male','female')) %>% 
    group_by(gender) %>% 
    summarise(cnt=n()
              ,avg=mean(age)
              ,oldest=max(age)
              ,total = paste(round(cnt/nrow(profile)*100,0),"%")
              )

ggplot(plot_left_1_df, aes(x="", y=cnt, fill=gender)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +  theme_void() + scale_fill_manual(values=c("#1e8d95", "#ffa786")) + geom_text(aes(label = total), position = position_stack(vjust = 0.5), color = "white", size=6)
```

</div>

<div style="float: right; width: 40%;">

```{r}
rbind(`Total # patients:` = nrow(profile)
      ,`Percentage men:` = percentage_men
      ,`Avg age man:` = round(plot_left_1_df[plot_left_1_df$gender=='male',][['avg']],1)
      ,`Avg age women:` = round(plot_left_1_df[plot_left_1_df$gender!='male',][['avg']],1)
      ,`Oldest male participant:` = round(plot_left_1_df[plot_left_1_df$gender=='male',][['oldest']],1)
      ,`Oldest female participant:` = round(plot_left_1_df[plot_left_1_df$gender!='male',][['oldest']],1)
      ) %>%
    kable(caption = "Table with gender based metrics") %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)
```
</div>

## Age distribution

The distribution of age groups amongst your patients. 

<div style="float: left; width: 70%;">


```{r echo=FALSE}
plot_right_1_df <-
    profile %>% 
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days'))
           ,age = age / 365
           ,age = ifelse(age<20,'<20'
                 ,ifelse(age<30,'20-30'
                 ,ifelse(age<40,'30-40'
                 ,ifelse(age<50,'40-50'
                 ,ifelse(age<60,'50-60'
                 ,ifelse(age<70,'60-70'
                 ,ifelse(age<80,'70-80','>80')))))))) %>% 

    group_by(age) %>% 
    summarise(cnt=n()) %>% 
    ungroup %>% 
    mutate(cnt_=round(cnt/sum(cnt)*100,1)
           ,cnt__=round(cnt/sum(cnt),2)
           )
#manual reordering the table structure
pref_order_plot_right_1_df <- c('<20','20-30','30-40','40-50','50-60','60-70','70-80','>80')
plot_right_1_df$age <- factor( as.character(plot_right_1_df$age), levels=pref_order_plot_right_1_df )
plot_right_1_df <- plot_right_1_df[order(plot_right_1_df$age),]


ggplot(plot_right_1_df, aes(x=age, y=cnt, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95")+theme_minimal() + theme(legend.position = "none") + xlab("Age groups") + ylab("# subjects")  + geom_text(aes(label = cnt), vjust = 1.5, colour = "white")

```
</div>


<div style="float: right; width: 30%;">

```{r}
rbind(`Total number of participants:` = number_of_participants
      ,`Average age:` = average_age
      ,`Participants >40 years:` = scales::percent(sum(plot_right_1_df$cnt__[plot_right_1_df$age %in% c('40-50','50-60','60-70','70-80','>80')]))
      ,`Participants >50 years:` = scales::percent(sum(plot_right_1_df$cnt__[plot_right_1_df$age %in% c('50-60','60-70','70-80','>80')]))
      ,`Participants >60 years :` = scales::percent(sum(plot_right_1_df$cnt__[plot_right_1_df$age %in% c('60-70','70-80','>80')]))
      ,`Participants >70 years :` = scales::percent(sum(plot_right_1_df$cnt__[plot_right_1_df$age %in% c('70-80','>80')]))
      ,`Participants >80 years :` = scales::percent(sum(plot_right_1_df$cnt__[plot_right_1_df$age %in% c('>80')]))
      ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)



```
</div>

## Country distribution
The countries where your patients came from. 
<div style="float: left; width: 60%;">

```{r Country Analysis, echo=FALSE}

plot_country_total <-
  profile %>% 
  group_by(country) %>%
  summarise(freq=n_distinct(id))%>%
  mutate(cnt_=(freq/sum(freq)), cnt__=round(cnt_*100,1))
  names(plot_country_total)[names(plot_country_total) == "cnt__"] <- "Percentage" 
  plot_country <- plot_country_total[ c("country", "Percentage")]
  
  ggplot(plot_country_total, aes(x="", y=freq, fill=country)) +
  geom_bar(stat="identity", width=1, color="white") + scale_fill_brewer(palette="Greens") +
  coord_polar("y", start=0) +  theme_void() 
  
most_popular_country <- as.vector(plot_country_total%>% 
        arrange(-cnt_) %>%
        head(1) %>%
        .[[1]])
    
tot_countries <- nrow(plot_country_total)
```
</div>

<div style="float: right; width: 30%;">


```{r}

rbind(`Country with most users:`= most_popular_country,`Total countries:` = tot_countries )%>%
    kable(caption = "Table with country based metrics") %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)
```

</div>

## Phone distribution
An overview of which types of smartphones your patients use. 

<div style="float: left; width: 60%;">

```{r Phone analysis, echo=FALSE}

plot_right_2_df <-     
        profile %>% 
        select(fibricheck_info.device.manufacturer) %>% 
        group_by(device=fibricheck_info.device.manufacturer) %>% 
        summarise(cnt=n()) %>% 
        ungroup %>% 
        mutate(cnt_=round(cnt/sum(cnt)*100,1)
               ,cnt__=round(cnt/sum(cnt),2)) %>% 
        arrange(-cnt) %>% 
        group_by(device) %>% 
        summarise(cnt=sum(cnt)) %>% 
        ungroup %>% 
        mutate(cnt_=round(cnt/sum(cnt)*100,1)
               ,cnt__=round(cnt/sum(cnt),2)) %>% 
        arrange(-cnt)


  ggplot(plot_right_2_df, aes(x="", y=cnt__, fill=device)) +
  geom_bar(stat="identity", width=1, color="white") + scale_fill_brewer(palette="Greens") +
  coord_polar("y", start=0) +  theme_void() 


most_popular_device <- as.vector(plot_right_2_df%>% 
        arrange(-cnt) %>%
        head(1) %>%
        .[[1]])

perc_ios <- plot_right_2_df%>% 
        filter(tolower(device)=='apple') %>% 
        mutate(cnt__=scales::percent(cnt__)) %>% 
        .[[4]]

insufficient_quality <- scales::percent(round((nrow(filter(measurments, data.indicator == "quality"))/total_number_of_measurements),2))

```
</div>

<div style="float: right; width: 30%;">

```{r}
rbind(`Most popular device:`= most_popular_device,`Percentage iOS:` = perc_ios, `Average % insufficient quality:` = insufficient_quality)%>%
    kable(caption = "Table with phone based metrics") %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)
```
</div>
## Phone performance
Distribution of insufficient quality by phone manufacturer

```{r }

plost_insuffqual <-     
        measurments %>% 
        group_by(device=data.device.manufacturer, indicator = data.indicator) %>% 
        summarise (cnt = n())%>%
        spread(indicator, cnt) %>%
        replace(is.na(.), 0) %>%
        rowwise() %>%
        mutate(total = sum(c(normal, warning, quality, urgent))) %>%
        mutate(insuff_q = round((quality/total)*100,1))

o1 <- ggplot(plost_insuffqual, aes(x=device, y=insuff_q, fill="#1e8d95")) + 
     geom_bar(stat="identity", fill = "#3b7bdb")+theme_minimal() +
     theme(legend.position = "none") +
     xlab("Device manufacturers") +
     ylab("% of insufficient quality") +  
     geom_text(aes(label = insuff_q), vjust = 1.5, colour = "white")

o2 <-  ggplot(plost_insuffqual, aes(x=device, y=total, fill="#1e8d95")) + 
     geom_bar(stat="identity", fill = "#1e8d95")+theme_minimal() +
     theme(legend.position = "none") +
     ylab("Amount of measurements taken") +  
     geom_text(aes(label = total), vjust = 1.5, colour = "white")

ggarrange(o2, o1, nrow = 2)

     
```


## Medical History
The following table shows the medical history information obtained from your patient population

```{r, message=FALSE, echo=FALSE}

#list of people with AF
list_user_id_AF <- 
  measurments%>%
  filter(data.diagnosis.label.0 == "atrial_fibrillation") %>%
  group_by(userIds.0)%>%
  summarise(n_distinct(userIds.0))%>%
  select(userIds.0)%>%
  as.vector()

#MEDICAL HISTORY PROFILE total

medical_history<-
      profile[c("id","gender","birthday", "custom_fields.arrhythmias", "custom_fields.atrialFibrillationKnowledge", "custom_fields.arrhythmias", "custom_fields.heartFailure", "custom_fields.arteryDisease", "custom_fields.atrialFibrillation", "custom_fields.stroke", "custom_fields.hypertension", "custom_fields.diabetes", "custom_fields.bloodThinner")] %>%
      mutate(age = round(age_calc(birthday, units = "years"))) 

      data <- as.matrix(medical_history)
      data[which(data == "false")] <- "0"
      data[which(data == "true")] <- "1"
      data <-as.data.frame(data)
      
      #data$custom_fields.arrhythmias <-as.numeric(data$custom_fields.arrhythmias)

      data$custom_fields.atrialFibrillationKnowledge <-as.numeric(data$custom_fields.atrialFibrillationKnowledge)
      data$custom_fields.heartFailure<-as.numeric(data$custom_fields.heartFailure)
      data$custom_fields.arteryDisease<-as.numeric(data$custom_fields.arteryDisease)
      data$custom_fields.atrialFibrillation<-as.numeric(data$custom_fields.atrialFibrillation)
      data$custom_fields.stroke<-as.numeric(data$custom_fields.stroke)
      data$custom_fields.hypertension<-as.numeric(data$custom_fields.hypertension)
      data$custom_fields.diabetes<-as.numeric(data$custom_fields.diabetes)
      data$custom_fields.bloodThinner <-as.numeric(data$custom_fields.bloodThinner)
      data$age <-as.numeric(data$age)
      data$gender <-as.numeric(data$gender)

      blank_rows <- sum(rowSums(is.na(data))>2)
      filled_in <-nrow(data)-blank_rows    
      
      
      AF_knowledge <- sum(data$custom_fields.atrialFibrillationKnowledge, na.rm=TRUE)
      HF <- sum(data$custom_fields.heartFailure, na.rm=TRUE)
      AD <-sum(data$custom_fields.arteryDisease, na.rm=TRUE)
      AF_history <-sum(data$custom_fields.atrialFibrillation, na.rm=TRUE)
      stroke <- sum( data$custom_fields.stroke, na.rm=TRUE)
      hypertension<- sum(data$custom_fields.hypertension, na.rm=TRUE)
      diabetes<- sum(data$custom_fields.diabetes, na.rm=TRUE)
      bloodthinner<- sum(data$custom_fields.bloodThinner, na.rm=TRUE)
      blank_rows <- sum(rowSums(is.na(data))>2)
      filled_in <-nrow(data) - blank_rows    
      
      History.df <- data.frame(AF_knowledge,HF,AD,AF_history,stroke,hypertension,diabetes,bloodthinner) 
      

      

rbind(` Total` = paste(nrow(profile),"patients"),
      ` History of Heart Failure` = HF,
      ` History of Diabetes` = diabetes,
      ` History of Artery Disease` = AD,
      ` History of AF` = AF_history,
      ` History of hypertension` = hypertension,
      ` History of Stroke` = stroke,
      `Already takes a bloodthinner` = bloodthinner,
      `Amount of filled in questionnaires` = filled_in,
      `Amount of blank questionnaires` = blank_rows      ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = T,
        font_size = 14)
```

## Medical History of AF patients
The medical history data from the patients that had FibriCheck based AFib measurements

```{r}
# AF PATIENTS
medical_history_af<-
      profile[c("id","gender","birthday", "custom_fields.arrhythmias", "custom_fields.atrialFibrillationKnowledge", "custom_fields.arrhythmias", "custom_fields.heartFailure", "custom_fields.arteryDisease", "custom_fields.atrialFibrillation", "custom_fields.stroke", "custom_fields.hypertension", "custom_fields.diabetes", "custom_fields.bloodThinner")] %>%
      mutate(age = round(age_calc(birthday, units = "years"))) 

medical_history_af_2 <- filter(medical_history_af, (id %in% list_user_id_AF$userIds.0))

      data_af <- as.matrix(medical_history_af_2)
      data_af[which(data_af == "false")] <- "0"
      data_af[which(data_af == "true")] <- "1"
      data_af <-as.data.frame(data_af)
      
      #data$custom_fields.arrhythmias <-as.numeric(data$custom_fields.arrhythmias)

      data_af$custom_fields.atrialFibrillationKnowledge <-as.numeric(data_af$custom_fields.atrialFibrillationKnowledge)
      data_af$custom_fields.heartFailure<-as.numeric(data_af$custom_fields.heartFailure)
      data_af$custom_fields.arteryDisease<-as.numeric(data_af$custom_fields.arteryDisease)
      data_af$custom_fields.atrialFibrillation<-as.numeric(data_af$custom_fields.atrialFibrillation)
      data_af$custom_fields.stroke<-as.numeric(data_af$custom_fields.stroke)
      data_af$custom_fields.hypertension<-as.numeric(data_af$custom_fields.hypertension)
      data_af$custom_fields.diabetes<-as.numeric(data_af$custom_fields.diabetes)
      data_af$custom_fields.bloodThinner <-as.numeric(data_af$custom_fields.bloodThinner)
      data_af$age <-as.numeric(data_af$age)
      data_af$gender <-as.numeric(data_af$gender)

      blank_rows_af <- sum(rowSums(is.na(data_af))>2)
      filled_in_af <-nrow(data_af)-blank_rows_af    
      
      
      AF_knowledge_af <- sum(data_af$custom_fields.atrialFibrillationKnowledge, na.rm=TRUE)
      HF_af <- sum(data_af$custom_fields.heartFailure, na.rm=TRUE)
      AD_af <-sum(data_af$custom_fields.arteryDisease, na.rm=TRUE)
      AF_history_af <-sum(data_af$custom_fields.atrialFibrillation, na.rm=TRUE)
      stroke_af <- sum( data_af$custom_fields.stroke, na.rm=TRUE)
      hypertension_af<- sum(data_af$custom_fields.hypertension, na.rm=TRUE)
      diabetes_af<- sum(data_af$custom_fields.diabetes, na.rm=TRUE)
      bloodthinner_af<- sum(data_af$custom_fields.bloodThinner, na.rm=TRUE)
      blank_rows_af <- sum(rowSums(is.na(data_af))>2)
      filled_in_af <-nrow(data_af)-blank_rows_af    
      

rbind(` AF patients` = paste(nrow(list_user_id_AF),"of",nrow(profile),"patients"),
      ` History of Heart Failure` = HF_af,
      ` History of Diabetes` = diabetes_af,
      ` History of Artery Disease` = AD_af,
      ` History of AF` = AF_history_af,
      ` History of hypertension` = hypertension_af,
      ` History of Stroke` = stroke_af,
      `Already takes a bloodthinner` = bloodthinner_af,
      `Amount of filled in questionnaires` = filled_in_af,
      `Amount of blank questionnaires` = blank_rows_af
      ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = T,
        font_size = 14)
```

## Prescription activation information
Time series that plots the amount of prescriptions versus the date

<div style="float: left; width: 60%;">


```{r echo = FALSE}
plot_left_2_df <-     
    prescriptions %>% 
        select(paid_timestamp) %>% 
          mutate(date=as.POSIXct((paid_timestamp/1000) ,origin = "1970-01-01 00:00:00:000")) %>% 
        group_by(date=as.Date(date)) %>% 
        summarise(cnt=n()) %>% 
        ungroup %>% 
        mutate(cnt_=round(cnt/sum(cnt)*100,1)
              ,cnt__=round(cnt/sum(cnt),2))

ggplot(plot_left_2_df, aes(x=date, y=cnt, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95")+theme_minimal() + theme(legend.position = "none") + xlab("Date") + ylab("# activations") + ggtitle("Activations over time")
```

</div>

<div style="float: right; width: 20%;">

```{r echo = FALSE}
peck_hour <- 
    prescriptions %>% 
    select(paid_timestamp) %>% 
    ## https://www.freeformatter.com/epoch-timestamp-to-date-converter.html
    mutate(hour=hour(as.POSIXct((paid_timestamp/1000) ,origin = "1970-01-01 00:00:00:000"))) %>% 
    group_by(hour) %>% 
    summarise(cnt=n()) %>% 
    arrange(-cnt) %>% head(1) %>% .[[1]]
    
rbind(`Peak activation - day:` = as.character(as.Date(plot_left_2_df %>% arrange(-cnt) %>% head(1) %>% .[[1]],origin='1970-01-01'))
      ,`Peak activation - Time (UTC):` = peck_hour
      ) %>%
    kable(caption = "Table with activation metrics") %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = T,
        font_size = 14)
```

</div>

## Measurement behavior - measurement intensity
Distribution over time in which weeks measurements were taken. 

```{r warning=FALSE, message=FALSE, echo=FALSE}
plot_left_3_df <- 
    measurments %>% 
    select(creationTimestamp) %>% 
    mutate(date=as.Date(creationTimestamp)) %>% 
    group_by(w=week(date)) %>% 
    summarise(cnt=n()
              ,min_date=min(date)
              ,max_date=max(date)) %>% 
    ungroup() %>% 
    mutate(cnt_=round(cnt/sum(cnt)*100,1)
           ,cnt__=round(cnt/sum(cnt),2)) %>% 
    arrange(w) %>% 
    mutate(min_date=paste(day(min_date),month(min_date),sep='/')
           ,max_date=paste(day(max_date),month(max_date),sep='/')
           ,wd=paste(min_date,max_date,sep='-'))

ggplot(plot_left_3_df, aes(x=wd, y=cnt_, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95")+theme_minimal() + theme(legend.position = "none", axis.text.x = element_text(angle = 90)) + scale_x_discrete(limits = plot_left_3_df$wd) + xlab("Week") + ylab("# of measurements") + ggtitle("Amount of measurements on a weekly basis") + geom_text(aes(label = cnt_), size = 2, vjust = 1.5, colour = "white")

```


## Measurement behavior
Distribution of measurements taken throughout the day. Note that the time is GMT. 

<div style="float: left; width: 60%;">


```{r}
plot_right_3_df <- 
    measurments %>% 
    select(creationTimestamp) %>% 
    mutate(hour=hour(ymd_hms(creationTimestamp))
          ,hour_=ifelse(hour<2,'0-2 AM',
                ifelse(hour<4,'2-4 AM',
                ifelse(hour<6,'4-6 AM',
                ifelse(hour<8,'6-8 AM',
                ifelse(hour<10,'8-10 AM',
                ifelse(hour<12,'10-12 AM',
                ifelse(hour<14,'12-2 PM',
                ifelse(hour<16,'2-4 PM',
                ifelse(hour<18,'4-6 PM',
                ifelse(hour<20,'6-8 PM',
                ifelse(hour<22,'8-10 PM','10-12 PM')))))))))))) %>% 
    group_by(hour_) %>% 
    summarise(cnt=n(),min_hour=min(hour)) %>% 
    arrange(min_hour) 

ggplot(plot_right_3_df, aes(x=hour_, y=cnt, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95")+theme_minimal() + theme(legend.position = "none") +
  scale_x_discrete(limits=plot_right_3_df$hour_)+ xlab("Hour of the day (GMT timezone)") + ylab("# measurements") + geom_text(aes(label = cnt), vjust = 1.5, colour = "white")
```
</div>

<div style="float: right; width: 20%;">

```{r, message=FALSE, echo=FALSE}
max_measures_per_day <- 
    measurments %>% 
    select(creationTimestamp) %>% 
    mutate(date=as.Date(creationTimestamp)) %>% 
    group_by(date) %>% 
    summarise(cnt=n()) %>% 
    ungroup() %>% 
    summarise(max(cnt)) %>% .[[1]]
rbind(`Peak measurements (UTC): ` = plot_right_3_df %>% 
        arrange(-cnt) %>% 
        head(1) %>% 
        .[[1]]
      ,`Total number of measurements received:` = total_number_of_measurements
      ,`Max number of tot. measurements / day:` = max_measures_per_day
      ) %>%
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = T,
        font_size = 14)
```

</div>



## User compliance and motivation
- Users are asked to take `r m_per_day` per day
- Compliance is total performend measurements / total expected measurements
- Motivation is % of days that the patient actually performed `r m_per_day` per day

```{r}
MOTIVATION_DATA = NULL
for(i in 1:length(UserID))
{
  df_window = subset(measurments,userIds.0 == UserID[i])
  df_window = select(df_window, id, data.measurement_timestamp, data.heartrate,data.indicator,data.context.symptoms.0, data.context.symptoms.sym)
  df_window$symptoms <- as.numeric(ifelse((df_window$data.context.symptoms.sym == "NA")|(df_window$data.context.symptoms.sym == "0"),"0", "200"))
  
  #DF windown alculation for prescription durations
  df_prescription = subset(prescriptions,user_id == UserID[i])
  if(nrow(df_prescription) == 0) {next}
  
  #df_prescription$dur = df_prescription$duration/1000
  #df_prescription$activated_timestamp2 = as.Date(as.POSIXct((df_prescription$update_timestamp/1000),origin = "1970-01-01 00:00:00:000"))
  
  df_prescription$activated_timestamp2 = as_datetime((df_prescription$update_timestamp/1000)) 
  df_prescription$end_date = df_prescription$activated_timestamp2 + df_prescription$dur
  df_prescription$today = as_datetime(Today)
  total_prescription_days = sum(df_prescription$dur)
  Total_days_in_last_block = as.numeric(as_datetime(Today)-max(df_prescription$activated_timestamp2))
  Total_days_last_block = as.numeric(max(df_prescription$end_date)-max(df_prescription$activated_timestamp2))
  
  actual_prescription_days <- 
    if(max(df_prescription$end_date) >= Today)
    {
      actual_prescription_days=total_prescription_days - Total_days_last_block + Total_days_in_last_block
    } else {
      actual_prescription_days = total_prescription_days
    }
  df_window$data.measurement_timestamp <- as_datetime((df_window$data.measurement_timestamp/1000))   
  total_measurements = nrow(df_window)
  first_measurement = min(df_window$data.measurement_timestamp)
  last_measurement = max(df_window$data.measurement_timestamp)
  #Total_days = actual_prescription_days/60/60/24
  Total_days = actual_prescription_days

  Total_days_motivation_met = sum(table(as.Date(df_window$data.measurement_timestamp))>=m_per_day)
  compliance = round(100*sum(nrow(df_window))/(Total_days),2)
  motivation= round(sum((table(as.Date(df_window$data.measurement_timestamp))>=m_per_day))*100/Total_days,2)
  
summary <- data.frame(UserID[i],first_measurement, last_measurement, total_measurements, Total_days, actual_prescription_days, Total_days_motivation_met, compliance, motivation)
MOTIVATION_DATA <- rbind(MOTIVATION_DATA,summary)
}
```



```{r warning=FALSE, message=FALSE, echo=FALSE}
##NEW SECTION
#in order to make the compliance plot accurate, we'll need to create a table with the data generated from the per-patient level and build an aggregate view of this. Based on this table the following plots can be genrated. 

#MOTIVATION PLOT
motivation_plot <-
  MOTIVATION_DATA %>%
  group_by(UserID.i.) %>%
  mutate(cnt_= motivation, cnt__=round(cnt_), motivation = ifelse(cnt__<10,'<10%'
                                     ,ifelse(cnt__<20,'10%-20%'
                                             ,ifelse(cnt__<30,'20%-30%'
                                                     ,ifelse(cnt__<40,'30%-40%'
                                                             ,ifelse(cnt__<50,'40%-50%'
                                                                      ,ifelse(cnt__<60,'50%-60%'
                                                                               ,ifelse(cnt__<70,'60%-70%'
                                                                                        ,ifelse(cnt__<80,'70%-80%'
                                                                                                 ,ifelse(cnt__<90,'80%-90%'
                                                                                                          ,ifelse(cnt__<100,'90%-99%'
                                                                                                                   ,ifelse(cnt__<150,'l00%'
                                                                                                                           ))))))))))))                                                                                                                                                    

motivation_plot_total<-
    motivation_plot %>%
    group_by(motivation) %>%
    summarise(cnt=n())

tt1 <- ggplot(motivation_plot_total, aes(x=motivation, y=cnt, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95") +scale_x_discrete(limits=motivation_plot_total$motivation) + theme_minimal() + theme(legend.position = "none", axis.text.x = element_text(angle = 30)) + geom_text(aes(label = cnt), vjust = 1.5, colour = "white") + ggtitle("Distribution of user motivation") + ylab("Amount of patients") + xlab(paste('Motivation of patients (% of days where',m_per_day,'measurements per day were performed)'))

#COMPLIANCE PLOT

compliance_plot <-
  MOTIVATION_DATA %>%
  group_by(UserID.i.) %>%
  mutate(cnt_= compliance, cnt__=round(cnt_), compliance = ifelse(cnt__<10,'<10%'
                                     ,ifelse(cnt__<20,'10%-20%'
                                             ,ifelse(cnt__<30,'20%-30%'
                                                     ,ifelse(cnt__<40,'30%-40%'
                                                             ,ifelse(cnt__<50,'40%-50%'
                                                                      ,ifelse(cnt__<60,'50%-60%'
                                                                               ,ifelse(cnt__<70,'60%-70%'
                                                                                        ,ifelse(cnt__<80,'70%-80%'
                                                                                                 ,ifelse(cnt__<90,'80%-90%'
                                                                                                          ,ifelse(cnt__<100,'90%-100%'
                                                                                                                   ,ifelse(cnt__<150,'100% -150%'
                                                                                                                           ,ifelse(cnt__<200,'150%-200%'
                                                                                                                                   ,ifelse(cnt__>200,'more then
200%',"0%"))))))))))))))                                                                                                                                                             

compliance_plot_total<-
    compliance_plot %>%
    group_by(compliance) %>%
    summarise(cnt=n())
 
tt2 <-ggplot(compliance_plot_total, aes(x=compliance, y=cnt, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95") +scale_x_discrete(limits=compliance_plot_total$compliance) +theme_minimal() + theme(legend.position = "none", axis.text.x = element_text(angle = 30)) + geom_text(aes(label = cnt), vjust = 1.5, colour = "white") + ggtitle("Distribution of user compliance") + ylab("Amount of patients") 

ggarrange(tt1, tt2, nrow = 2)


```

## User compliance

```{r}
#COMPLIANCE PLOT

compliance_plot <-
  MOTIVATION_DATA %>%
  group_by(UserID.i.) %>%
  mutate(cnt_= compliance, cnt__=round(cnt_), compliance = ifelse(cnt__<10,'<10%'
                                     ,ifelse(cnt__<20,'10%-20%'
                                             ,ifelse(cnt__<30,'20%-30%'
                                                     ,ifelse(cnt__<40,'30%-40%'
                                                             ,ifelse(cnt__<50,'40%-50%'
                                                                      ,ifelse(cnt__<60,'50%-60%'
                                                                               ,ifelse(cnt__<70,'60%-70%'
                                                                                        ,ifelse(cnt__<80,'70%-80%'
                                                                                                 ,ifelse(cnt__<90,'80%-90%'
                                                                                                          ,ifelse(cnt__<100,'90%-100%'
                                                                                                                   ,ifelse(cnt__<150,'100% -150%'
                                                                                                                           ,ifelse(cnt__<200,'150%-200%'
                                                                                                                                   ,ifelse(cnt__>200,'more then
200%',"/"))))))))))))))                                                                                                                                                             

compliance_plot_total<-
    compliance_plot %>%
    group_by(compliance) %>%
    summarise(cnt=n())
 
ggplot(compliance_plot_total, aes(x=compliance, y=cnt, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95") +scale_x_discrete(limits=compliance_plot_total$compliance) +theme_minimal() + theme(legend.position = "none", axis.text.x = element_text(angle = 30)) + geom_text(aes(label = cnt), vjust = 1.5, colour = "white") + ggtitle("Distribution of user compliance") + ylab("Amount of patients") 


```

## Amount of measurement per subject per age category

```{r}
plot_right_4_df_a <-
    profile %>% 
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days'))
           ,age = age / 365
           ,age = ifelse(age<20,'<20'
                         ,ifelse(age<30,'20-30'
                                 ,ifelse(age<40,'30-40'
                                         ,ifelse(age<50,'40-50'
                                                 ,ifelse(age<60,'50-60'
                                                         ,ifelse(age<70,'60-70','70-80'))))))) %>% 
    group_by(age) %>% 
    summarise(cnt=n()) %>%
    ungroup %>% 
    mutate(cnt_=round(cnt/sum(cnt)*100,1)
           ,cnt__=round(cnt/sum(cnt),1)
    )


plot_right_4_df_b <-
    inner_join(measurments,profile,by = c('creatorId'='id')) %>% 
    select(birthday,id,creatorId) %>% 
    mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days'))
           ,age = age / 365
           ,age = ifelse(age<20,'<20'
                         ,ifelse(age<30,'20-30'
                                 ,ifelse(age<40,'30-40'
                                         ,ifelse(age<50,'40-50'
                                                 ,ifelse(age<60,'50-60'
                                                         ,ifelse(age<70,'60-70','70-80'))))))) %>% 
    group_by(age) %>% 
    summarise(per_user_cnt=round(n()/n_distinct(creatorId))) 

plot_right_4_df <- inner_join(plot_right_4_df_a,plot_right_4_df_b)


ggplot(plot_right_4_df, aes(x=age, y=per_user_cnt, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95")+theme_minimal() + theme(legend.position = "none") + geom_text(aes(label = per_user_cnt), vjust = 1.5, colour = "white") + ggtitle("Average amount of measurement per subject per age group") + ylab("Average amount of measurements")
```

```{r, message=FALSE, echo=FALSE}
max_compliance <- as.vector(compliance_plot%>% 
        arrange(-cnt_) %>%
        head(1) %>%
        .[[4]])

avg_per_user <- 
    measurments %>% 
    select(userIds.0) %>% 
    group_by(userIds.0) %>% 
    summarise(cnt=n()) %>% 
    ungroup() %>% 
    summarise(round(mean(cnt))) %>% .[[1]]

rbind(`Most compliant user (%):` = paste (as.character(max_compliance),"%", sep = "", collapse = NULL)
      ,`Average number of measurements/user:` = avg_per_user
      ,`Average compliance (%):` =  paste (as.character(round(mean(compliance_plot$cnt__))),"%", sep = "", collapse = NULL)) %>% 
    kable() %>%
    kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = T,
        font_size = 14)
```

## Diagnostics

```{r, message=FALSE, echo=FALSE}

most_common <- as.character(
    measurments %>% 
    select(data.context.symptoms.0) %>% 
    group_by(type=data.context.symptoms.0) %>% 
    summarise(cnt=n()) %>% 
   filter(type != "no_symptoms") %>%  
   filter(type != "") %>% 
    ungroup() %>% 
    arrange(-cnt) %>% 
  head(1)%>% .[[1]])

measurement_without_symptoms <- as.numeric( measurments %>% 
    select(data.context.symptoms.0) %>% 
    group_by(type=data.context.symptoms.0) %>% 
    summarise(cnt=n()) %>% 
    filter(type == "no_symptoms") %>% 
    head(1)%>% .[[2]])

Total_measurements_with_symptoms <- as.numeric(total_number_of_measurements)-measurement_without_symptoms

total_af_measurements <- as.numeric(
    measurments %>% 
    select(data.context.symptoms.0, data.diagnosis.label.0) %>% 
   filter(data.diagnosis.label.0 == "atrial_fibrillation") %>%
  summarise(cnt=n()) %>%
   ungroup() %>% 
  head(1)%>% .[[1]])
  
  
af_measurements_nosymptoms <- as.numeric(
    measurments %>% 
    select(data.context.symptoms.0, data.diagnosis.label.0) %>% 
   filter(data.diagnosis.label.0 == "atrial_fibrillation") %>%
  group_by(type=data.context.symptoms.0) %>% 
      summarise(cnt=n()) %>%
      filter(type == "no_symptoms") %>% 
    ungroup() %>% 
  head(1)%>% .[[2]])

hr_AF <- 
    measurments %>% 
    filter(data.diagnosis.label.0== "atrial_fibrillation")
mean_HR_AF = round(mean(hr_AF$data.heartrate))

hr_non_AF <- 
    measurments %>% 
    filter(data.diagnosis.label.0 != "atrial_fibrillation")
mean_HR_non_AF = round(mean(hr_non_AF$data.heartrate))
  



rbind(`Amount of people with Atrial Fibrillation:` = people_with_atrial_fibrillation, `Amount of people with other cardiac arrhythmia's:` = people_with_other_cardiac_arrhythmias, `Average heart rate of non-AF people (bpm):` = mean_HR_non_AF
      ,`Average heart rate during AF (bpm):` = mean_HR_AF,`Measurements with symptoms (%):` = scales::percent(Total_measurements_with_symptoms/as.numeric(total_number_of_measurements))
      ,`AF-measurements with symptoms:` = total_af_measurements - af_measurements_nosymptoms
      ,`Most common symptom:` = most_common
      ) %>%
    kable() %>%
   kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = TRUE,
        font_size = 14)


hr_AF <- 
  measurments %>% 
  filter(data.diagnosis.label.0== "atrial_fibrillation")

mean_HR_AF = round(mean(hr_AF$data.heartrate))

hr_non_AF <- 
      measurments %>% 
      filter(data.diagnosis.label.0 != "atrial_fibrillation")
  mean_HR_non_AF = round(mean(hr_non_AF$data.heartrate))
  
ggplot(arrhythmia_table, aes(x="", y=Frequency, fill=`Heart rhythm`)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +  theme_void() 

 kable(arrhythmia_table) %>%
     kable_styling(
          bootstrap_options = c("hover", "condensed", "responsive"),
          full_width = FALSE,
          position = "float_left",
          font_size = 14)
 
 symptom_table <-
  measurments %>%
  group_by(data.context.symptoms.0) %>%
  summarise(freq = n_distinct(id)) %>%
  arrange (-freq) %>% 
  mutate(fraction=round((freq/sum(freq))*100,1))%>%
mutate_all(na_if,"")

  
names(symptom_table)[names(symptom_table) == "data.context.symptoms.0"] <- "Symptoms"
names(symptom_table)[names(symptom_table) == "freq"] <- "Frequency"
names(symptom_table)[names(symptom_table) == "fraction"] <- "%"

kable(symptom_table) %>%
      kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        position = "float_right",
        font_size = 14)

 

```

```{r, message=FALSE,warning=FALSE, echo=FALSE}

plot_left_4_df <-
   measurments %>% 
    select(data.context.symptoms.0) %>% 
    group_by(type=data.context.symptoms.0) %>% 
    summarise(cnt=n()) %>% 
    filter(!is.na(type)) %>% 
    ungroup() %>% 
    arrange(-cnt)

ggplot(plot_left_4_df, aes(x="", y=cnt, fill=type)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +  theme_void() 


```

```{r, message=FALSE,warning=FALSE, echo=FALSE}
sinus_rhythm <- as.character(c("sinus","increased HRV"))
measurments$data.context.symptoms.0 <- as.character(measurments$data.context.symptoms.0)
measurments$id <- as.character(measurments$id)

symptoms_table_sinus <-
      measurments%>%
      filter(data.diagnosis.label.0 %in% sinus_rhythm )%>%
      group_by(data.context.symptoms.0)%>%
      summarize(freq = n_distinct(id))%>%
      arrange (-freq)%>%
      mutate(fraction=round((freq/sum(freq))*100,1))%>%
mutate_all(na_if,"")
  

names(symptoms_table_sinus)[names(symptoms_table_sinus) == "data.context.symptoms.0"] <- "Symptoms"
names(symptoms_table_sinus)[names(symptoms_table_sinus) == "freq"] <- "Frequency"
names(symptoms_table_sinus)[names(symptoms_table_sinus) == "fraction"] <- "%"

kable(symptoms_table_sinus,caption = "Symptoms during sinus rhythms") %>%
      kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)



```

```{r, message=FALSE,warning=FALSE, echo=FALSE}
non_AF <- c("extrasystoles_frequent","extrasystoles_isolated","tachycardia", "extrasystoles_big_episode","extrasystoles_trig_episode","extrasystoles_bigminy")
symptoms_table_non_af <-
      measurments %>%
      filter(data.diagnosis.label.0 %in% non_AF)%>%
      group_by(data.context.symptoms.0) %>%
      summarise(freq = n_distinct(id)) %>% 
      arrange (-freq) %>% 
      mutate(fraction=round((freq/sum(freq))*100,1))%>%
mutate_all(na_if,"")

names(symptoms_table_non_af)[names(symptoms_table_non_af) == "data.context.symptoms.0"] <- "Symptoms"
names(symptoms_table_non_af)[names(symptoms_table_non_af) == "freq"] <- "Frequency"
names(symptoms_table_non_af)[names(symptoms_table_non_af) == "fraction"] <- "%"

kable(symptoms_table_non_af, caption = "Symptoms during non-AF rhythms") %>%
      kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)


```

```{r, message=FALSE,warning=FALSE, echo=FALSE}

AF_rhythms<-c("atrial_fibrillation","atrial_flutter")
symptoms_table_af <-
      measurments %>%
      filter(data.diagnosis.label.0 %in% AF_rhythms ) %>%
      group_by(data.context.symptoms.0) %>%
      summarise(freq = n_distinct(id)) %>%
      arrange (-freq) %>%
      mutate(fraction=round((freq/sum(freq))*100,1))%>%
mutate_all(na_if,"")
names(symptoms_table_af)[names(symptoms_table_af) == "data.context.symptoms.0"] <- "Symptoms"
names(symptoms_table_af)[names(symptoms_table_af) == "freq"] <- "Frequency"
names(symptoms_table_af)[names(symptoms_table_af) == "fraction"] <- "%"

kable(symptoms_table_af,caption = "Symptoms during AF rhythms") %>%
      kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)


```

## Prescription types that are issued

```{r eval = FALSE, message=FALSE, include=FALSE}

prescription_types <- c("PATIENT_REQUEST","NEW_COMPLAINTS","HIGH_RISK","POST_ABLATION","OTHER","LASTING_COMPLAINTS","POST_CRYPTOGENIC_STROKE","POST_CARDIOVERSION") 
plot_prescriptions_type <-
   prescriptions %>% 
    select(tags.0) %>% 
    group_by(type=tags.0) %>% 
    summarise(cnt=n()) %>% 
    #filter(!is.na(type)) %>% 
    #filter(type == prescription_types)%>%
    ungroup() %>% 
    arrange(-cnt)
plot_prescriptions_type <- filter(plot_prescriptions_type, (type %in% prescription_types))

ggplot(plot_prescriptions_type, aes(x=type, y=cnt, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95")+theme_minimal() + theme(legend.position = "none",  axis.text.x = element_text(angle = 45, vjust=0.7)) + geom_text(aes(label = cnt), vjust = -1, colour = "black") + xlab("Type of prescriptions") + ylab("Amount of prescriptions") + ylim(0, max(plot_prescriptions_type$cnt)+30)

identified_prescriptions <- sum(plot_prescriptions_type$cnt)
total_prescriptions <- nrow(prescriptions)
total_unidentifiedprescriptions <- total_prescriptions-identified_prescriptions
Unidentified_prescriptions <- data.frame("NO TAG",total_unidentifiedprescriptions)
names(Unidentified_prescriptions) <- c("type","cnt")
plot_prescriptions_type <- rbind(plot_prescriptions_type, Unidentified_prescriptions)

kable(plot_prescriptions_type) %>%
      kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)

```

```{r, message=FALSE, echo=FALSE}

plot_prescriptions_duration <-
   prescriptions %>% 
    select(dur) %>% 
    group_by(type=dur) %>% 
    summarise(cnt=n()) %>% 
    #filter(!is.na(type)) %>% 
    #filter(type == prescription_types)%>%
    ungroup() %>% 
    arrange(type)

plot_prescriptions_duration$type <- as.factor(plot_prescriptions_duration$type)
  

ggplot(plot_prescriptions_duration, aes(x=as.character(type), y=cnt)) +
  geom_bar(stat="identity", fill = "#1e8d95"  )+theme_minimal() + theme(legend.position = "none",  axis.text.x = element_text(angle = 45, vjust=0.7)) + geom_text(aes(label = cnt), vjust = -1, colour = "black") + xlab("Prescription duration (days)") + ylab("Amount of prescriptions") + ylim(0, max(plot_prescriptions_duration$cnt)+30) + scale_x_discrete(limits = plot_prescriptions_duration$type) + ggtitle("Distribution of type of prescriptions provided ")

kable(plot_prescriptions_duration) %>%
      kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)

```

## Plot the correlation beetwen prescription duration and indication

```{r eval = FALSE, message=FALSE, include=FALSE}
plot_correlation_prescriptions_duration_type <-
   prescriptions %>% 
    select(dur, tags.0)  %>%
    group_by(duration=dur,tag = tags.0 ) %>% 
    summarise(cnt=n())  %>%
    #filter(!is.na(type)) %>% 
    #filter(type == prescription_types)%>%
    ungroup()  %>% 
    arrange(duration)

plot_correlation_prescriptions_duration_type <- filter(plot_correlation_prescriptions_duration_type, (tag %in% prescription_types))
plot_correlation_prescriptions_duration_type$duration <- as.factor(plot_correlation_prescriptions_duration_type$duration)

ggplot(plot_correlation_prescriptions_duration_type, aes(duration, tag)) + geom_point(aes(size = cnt), colour = "#1e8d95") + theme_bw() + xlab("") + ylab("") + scale_size_continuous(range=c(3,20)) + geom_text(aes(label = cnt),colour="white") + xlab("Prescription duration") 

```

## Where do my patients come from, and where do they go

The following plot is a Sankey plot which shows the progress of your patients within the FibriCheck ecosystem. They start on the left side in a specific "group" and move then to the right side in the group where they ended. The table below visualises the SankeyPlot in a table format. 

```{r, eval = TRUE, message=FALSE, echo=FALSE}
# 1. each user, arrange the data by the timestamp
# 2. create a sequence of numbers from 1:N (N=the number of flows each user had)
# 3. create the next step of the user using the lead() with step=1
# 4. aggrate all the flows made by all the users
# 5. create a dummy flow which called "out". each user which ended the flow will have as a final step "out"
#data_sankey_prescriptions2 <- filter(data_sankey_prescriptions, group_id != "5c90a3294cedfd0006206e08")


agg <-
    data_sankey_prescriptions %>%
    arrange(user_id, creation_timestamp) %>%
    group_by(user_id) %>%
    mutate(
        type=gsub(' ','_',grouptype),
        from = 1:n(),
        next_type = lead(type, 1),
        to = lead(from, 1)
    ) %>%
    ungroup() %>%
    group_by(from, to, type, next_type)%>%
    summarise(cnt = n_distinct(user_id)) %>%
    ungroup() %>%
    mutate(to = ifelse(is.na(to), from + 1, to),
           next_type = ifelse(is.na(next_type), 'out', next_type))



# sankey plot function
# the function have 7 variables
# 1. df - holds data in a data.frame format
# 2. min_num_users - the minimum number of users you wish to had in each flow
# 3. max_num_steps - the maximum number of flows you wish to get
# 4. width - the plot width
# 5. height - the plot height
# 6. save - an option to save the plot as HTML file. Deafult set to false
# 7 file_name - the name of the saved HTML file


#amount_data <- as.numeric(count(data))
# run the get_sankey_plot. you can change any of the params, beside the "agg"

#get_sankey_plot(agg, min_num_users = 1, max_num_steps = 2, width = 1400, 
 #               height = 700, save = T, file_name = 'sankyplot_1_min_users_10_steps.html')


get_sankey_plot(agg, min_num_users = 1, max_num_steps = 3, width = 900, 
                height = 1000, save = T,file_name = 'sankey.html')

htmltools::includeHTML("./sankey.html")

kable(agg) %>%
      kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)

write.csv(agg,"/Users/larsgrieten/desktop/agg.csv" )
```


## Signal Quality Analysis

```{r}
measurerement_profiles_1 <-
  meas_prof_file %>%
  select(userIds.0, birthday) %>%
  mutate(age = as.numeric(difftime(Sys.Date(), birthday, units = 'days'))
         ,age = age / 365
         ,age = ifelse(age<20,'<20'
                       ,ifelse(age<30,'20-30'
                               ,ifelse(age<40,'30-40'
                                       ,ifelse(age<50,'40-50'
                                               ,ifelse(age<60,'50-60'
                                                       ,ifelse(age<70,'60-70','70-80')))))), cnt= n()) %>%
  group_by(userIds.0, age) %>%
  summarise(n()) 
  
  

measurerement_profiles_2 <-
  meas_prof_file %>%
  group_by(userid=userIds.0, indicator = data.indicator) %>% 
  summarise (cnt = n())%>%
  spread(indicator, cnt) %>%
  replace(is.na(.), 0) %>%
  rowwise() %>%
  mutate(total = sum(c(normal, warning, quality, urgent))) %>%
  mutate(insuff_q = round((quality/total)*100,1))

measurerement_profiles <- inner_join(measurerement_profiles_2,measurerement_profiles_1, by = c('userid'='userIds.0'))

measurerement_profiles_fin <- 
  measurerement_profiles %>%
  group_by(age) %>%
  summarize(mean_Q = round(mean(insuff_q, na.rm = TRUE),2))


ggplot(measurerement_profiles_fin, aes(x=age, y=mean_Q, fill="#1e8d95")) +
  geom_bar(stat="identity", fill = "#1e8d95")+theme_minimal() + theme(legend.position = "none") + xlab("Age groups") + ylab("Average insufficient quality")  + geom_text(aes(label = mean_Q), vjust = 1.5, colour = "white")

```



## Measurement attempts

```{r, message=FALSE, echo=FALSE, warning=FALSE}
# TABULATE MEASUREMENT ATTEMPTS PER USER AND MEASUREMENT
meas_attempt_measurement <-
  measurments %>%
  group_by(data.attempts) %>%
summarise(freq=n_distinct(id))%>%
mutate(cnt_=(freq/sum(freq)), cnt__=round(cnt_*100,1))
names(meas_attempt_measurement)[names(meas_attempt_measurement) == "data.attempts"] <- "Meas. attempts"
names(meas_attempt_measurement)[names(meas_attempt_measurement) == "cnt__"] <- "Percentage (%)" 
meas_attempt_measurement_subset <- meas_attempt_measurement[ c("Meas. attempts", "Percentage (%)")]


kable(meas_attempt_measurement_subset) %>%
      kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}

# TABULATE MEASUREMENT QUALITY VS ACTIVITY

percent_quality_activity <-as.data.frame(cast(measurments, data.context.activity  ~ data.diagnosis.label.0)  %>%
  select(data.context.activity, quality_to_low)%>%
  mutate_all(na_if,""))%>%
  arrange(-quality_to_low)
percent_quality_activity$quality_to_low <- round(percent_quality_activity$quality_to_low/sum(percent_quality_activity$quality_to_low)*100,1)

names(percent_quality_activity)[names(percent_quality_activity) == "data.context.activity"] <- "Activity context" 
names(percent_quality_activity)[names(percent_quality_activity) == "quality_to_low"] <- "Insufficient quality distribution (%)" 

  
kable(percent_quality_activity) %>%
      kable_styling(
        bootstrap_options = c("hover", "condensed", "responsive"),
        full_width = F,
        font_size = 14)

```


## Individual plots

```{r echo=FALSE, message=FALSE, warning=FALSE}
for(i in 1:length(UserID))
{
  
df_window = subset(measurments,userIds.0 == UserID[i])
df_window = select(df_window, id, data.measurement_timestamp, data.heartrate,data.indicator,data.context.symptoms.0, data.context.symptoms.sym)
df_window$symptoms <- as.numeric(ifelse((df_window$data.context.symptoms.sym == "NA")|(df_window$data.context.symptoms.sym == "0"),"0", "200"))

#DF windown alculation for prescription durations
  df_prescription = subset(prescriptions,user_id == UserID[i])
  if(nrow(df_prescription) == 0) {next}
  
  df_prescription$dur = df_prescription$duration/1000
  #df_prescription$activated_timestamp2 = as.Date(as.POSIXct((df_prescription$update_timestamp/1000),origin = "1970-01-01 00:00:00:000"))
  
  df_prescription$activated_timestamp2 = as_datetime((df_prescription$update_timestamp/1000)) 
  df_prescription$end_date = df_prescription$activated_timestamp2 + df_prescription$dur
  df_prescription$today = Today
  total_prescription_days = sum(df_prescription$dur)
  Total_days_in_last_block = as.numeric(Today-max(df_prescription$activated_timestamp2))
  Total_days_last_block = as.numeric(max(df_prescription$end_date)-max(df_prescription$activated_timestamp2))
  
  actual_prescription_days <- 
  if(max(df_prescription$end_date) >= Today)
  {
  actual_prescription_days=total_prescription_days - Total_days_last_block + Total_days_in_last_block
  } else {
   actual_prescription_days = total_prescription_days
  }
  
df_window$data.measurement_timestamp <- as_datetime((df_window$data.measurement_timestamp/1000))   

first_measurement = min(df_window$data.measurement_timestamp)
last_measurement = max(df_window$data.measurement_timestamp)
Total_days = actual_prescription_days/60/60/24
Total_days_motivation_met = sum(table(as.Date(df_window$data.measurement_timestamp))>=m_per_day)
compliance = round(100*sum(nrow(df_window))/(Total_days),2)
motivation= round(sum((table(as.Date(df_window$data.measurement_timestamp))>=m_per_day))*100/Total_days,2)

#df_window$data.measurement_timestamp=as.Date(as.POSIXct((df_window$data.measurement_timestamp/1000),origin = "1970-01-01 00:00:00:000"))



p1 <- ggplot(df_window) +
          geom_point(aes(x=data.measurement_timestamp,
                   y=data.heartrate, color=data.indicator)) +
          scale_colour_manual(values = c("warning" = "#f09034", "urgent" = "#dc324a",
                                   "normal" = "#6bacb2","Quality" = "blue",
                                   "Symptoms Was Present"="black")) + 
          geom_point(aes(x=data.measurement_timestamp,
                         y=symptoms)) +
          xlab("Date/time") + ylab("Heart rate (BPM)") + ylim(30, 200)+ theme_minimal() +
          labs(color='Heart rhythm', title= paste("User ID:",UserID[i], "#rec:",nrow(df_window), "Compliance",compliance, "Motivation", motivation)) +
          theme(legend.title =element_blank(),legend.position = "top", )

 #### REPEAT PLOT####
  rect <- data.frame(xmin=df_prescription$activated_timestamp2, xmax=df_prescription$end_date, ymin=-Inf, ymax=Inf)
  p1 <- p1 + geom_rect(data=rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax),
              color="grey90",
              alpha=0.05,
              inherit.aes = FALSE) 
  
  
print(p1)  
}
```



