<!doctype HTML>
<meta charset = 'utf-8'>
<html>
  <head>
    
    <link rel='stylesheet' href='http://timelyportfolio.github.io/rCharts_d3_sankey/css/sankey.css'>
    
    
    
    <script src='http://timelyportfolio.github.io/rCharts_d3_sankey/js/d3.v3.js' type='text/javascript'></script>
    
    <script src='http://timelyportfolio.github.io/rCharts_d3_sankey/js/sankey.js' type='text/javascript'></script>
    
    
    <style>
    .rChart {
      display: block;
      margin-left: auto; 
      margin-right: auto;
      width: 900px;
      height: 1000px;
    }  
    </style>
    
  </head>
  <body >
    
    <div id = 'charte3501f7e64fe' class = 'rChart rCharts_d3_sankey'></div>    
    <!--Attribution:
Mike Bostock https://github.com/d3/d3-plugins/tree/master/sankey
Mike Bostock http://bost.ocks.org/mike/sankey/
-->

<script>
(function(){
var params = {
 "dom": "charte3501f7e64fe",
"width":      900,
"height":     1000,
"data": {
 "source": [ "1_B2C", "1_B2C", "1_B2C", "1_B2C", "1_B2C", "1_B2C", "1_B2C", "1_B2C", "1_D2P", "1_D2P", "1_D2P", "1_D2P", "1_D2P", "1_D2P", "1_Demo", "1_Demo", "1_Demo", "1_Demo", "1_Demo", "1_Demo", "1_Demo", "1_FREE-TRIAL", "1_FREE-TRIAL", "1_FREE-TRIAL", "1_FREE-TRIAL", "1_FREE-TRIAL", "1_FREE-TRIAL", "1_FREE-TRIAL", "1_Other", "1_Other", "1_Other", "1_Other", "1_Other", "1_Other", "1_Other", "1_Research", "1_Research", "1_Research", "1_Research", "1_Research", "1_Research", "1_Screening", "1_Screening", "1_Screening", "1_Screening", "1_Screening", "1_Screening", "1_Screening", "1_SemiContinuous", "1_SemiContinuous", "1_B2C", "1_D2P", "1_Demo", "1_FREE-TRIAL", "1_Other", "1_OTHER", "1_Research", "1_RESEARCH", "1_Screening", "1_SemiContinuous", "2_B2C", "2_B2C", "2_B2C", "2_B2C", "2_B2C", "2_B2C", "2_B2C", "2_B2C", "2_D2P", "2_D2P", "2_D2P", "2_D2P", "2_D2P", "2_D2P", "2_Demo", "2_Demo", "2_Demo", "2_Demo", "2_Demo", "2_Demo", "2_Demo", "2_FREE-TRIAL", "2_FREE-TRIAL", "2_FREE-TRIAL", "2_FREE-TRIAL", "2_FREE-TRIAL", "2_FREE-TRIAL", "2_FREE-TRIAL", "2_Other", "2_Other", "2_Other", "2_Research", "2_Research", "2_Research", "2_Research", "2_Research", "2_Research", "2_Screening", "2_Screening", "2_Screening", "2_Screening", "2_Screening", "2_Screening", "2_SemiContinuous", "2_B2C", "2_D2P", "2_Demo", "2_FREE-TRIAL", "2_Other", "2_Research", "2_Screening", "2_SemiContinuous" ],
"target": [ "2_B2C", "2_D2P", "2_Demo", "2_FREE-TRIAL", "2_Other", "2_Research", "2_Screening", "2_SemiContinuous", "2_B2C", "2_D2P", "2_Demo", "2_FREE-TRIAL", "2_Research", "2_Screening", "2_B2C", "2_D2P", "2_Demo", "2_FREE-TRIAL", "2_Other", "2_Research", "2_Screening", "2_B2C", "2_D2P", "2_Demo", "2_FREE-TRIAL", "2_Research", "2_Screening", "2_SemiContinuous", "2_B2C", "2_D2P", "2_Demo", "2_FREE-TRIAL", "2_Other", "2_Research", "2_Screening", "2_B2C", "2_D2P", "2_Demo", "2_FREE-TRIAL", "2_Research", "2_Screening", "2_B2C", "2_D2P", "2_Demo", "2_FREE-TRIAL", "2_Research", "2_Screening", "2_SemiContinuous", "2_B2C", "2_FREE-TRIAL", "2_out", "2_out", "2_out", "2_out", "2_out", "2_out", "2_out", "2_out", "2_out", "2_out", "3_B2C", "3_D2P", "3_Demo", "3_FREE-TRIAL", "3_Other", "3_RESEARCH", "3_Screening", "3_SemiContinuous", "3_B2C", "3_D2P", "3_Demo", "3_FREE-TRIAL", "3_Research", "3_Screening", "3_B2C", "3_D2P", "3_Demo", "3_FREE-TRIAL", "3_Other", "3_Research", "3_Screening", "3_B2C", "3_D2P", "3_Demo", "3_FREE-TRIAL", "3_Research", "3_Screening", "3_SemiContinuous", "3_Demo", "3_Other", "3_Screening", "3_B2C", "3_D2P", "3_Demo", "3_FREE-TRIAL", "3_Research", "3_Screening", "3_B2C", "3_D2P", "3_Demo", "3_FREE-TRIAL", "3_OTHER", "3_Screening", "3_FREE-TRIAL", "3_out", "3_out", "3_out", "3_out", "3_out", "3_out", "3_out", "3_out" ],
"value": [ 784, 80, 38, 1094, 1, 1, 106, 1, 296, 1203, 2, 1713, 8, 131, 10, 13, 60, 49, 2, 5, 23, 15422, 867, 735, 17888, 36, 609, 4, 6, 2, 1, 2, 3, 1, 5, 2, 10, 2, 69, 19, 1, 805, 6687, 27, 6074, 2, 5268, 1, 2, 4, 10858, 10401, 573, 411152, 76, 1, 1179, 9, 64152, 41, 5818, 177, 24, 1572, 1, 1, 52, 2, 346, 1674, 7, 1601, 3, 225, 59, 10, 34, 71, 1, 2, 8, 2438, 224, 53, 1495, 2, 218, 2, 2, 1, 1, 2, 2, 2, 3, 10, 1, 127, 1612, 6, 806, 1, 297, 1, 9680, 5006, 680, 22461, 2, 52, 3294, 5 ] 
},
"nodePadding":       30,
"layout":       32,
"fontsize":        1,
"nodeWidth":       30,
"units": "users",
"title": "Sankey Diagram",
"id": "charte3501f7e64fe" 
};

params.units ? units = " " + params.units : units = "";

//hard code these now but eventually make available
var formatNumber = d3.format("0,.0f"),    // zero decimal places
    format = function(d) { return formatNumber(d) + units; },
    color = d3.scale.category20();

if(params.labelFormat){
  formatNumber = d3.format(".2%");
}

var svg = d3.select('#' + params.id).append("svg")
    .attr("width", params.width)
    .attr("height", params.height);
    
var sankey = d3.sankey()
    .nodeWidth(params.nodeWidth)
    .nodePadding(params.nodePadding)
    .layout(params.layout)
    .size([params.width,params.height]);
    
var path = sankey.link();
    
var data = params.data,
    links = [],
    nodes = [];
    
//get all source and target into nodes
//will reduce to unique in the next step
//also get links in object form
data.source.forEach(function (d, i) {
    nodes.push({ "name": data.source[i] });
    nodes.push({ "name": data.target[i] });
    links.push({ "source": data.source[i], "target": data.target[i], "value": +data.value[i] });
}); 

//now get nodes based on links data
//thanks Mike Bostock https://groups.google.com/d/msg/d3-js/pl297cFtIQk/Eso4q_eBu1IJ
//this handy little function returns only the distinct / unique nodes
nodes = d3.keys(d3.nest()
                .key(function (d) { return d.name; })
                .map(nodes));

//it appears d3 with force layout wants a numeric source and target
//so loop through each link replacing the text with its index from node
links.forEach(function (d, i) {
    links[i].source = nodes.indexOf(links[i].source);
    links[i].target = nodes.indexOf(links[i].target);
});

//now loop through each nodes to make nodes an array of objects rather than an array of strings
nodes.forEach(function (d, i) {
    nodes[i] = { "name": d };
});

sankey
  .nodes(nodes)
  .links(links)
  .layout(params.layout);
  
var link = svg.append("g").selectAll(".link")
  .data(links)
.enter().append("path")
  .attr("class", "link")
  .attr("d", path)
  .style("stroke-width", function (d) { return Math.max(1, d.dy); })
  .sort(function (a, b) { return b.dy - a.dy; });

link.append("title")
  .text(function (d) { return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value); });

var node = svg.append("g").selectAll(".node")
  .data(nodes)
.enter().append("g")
  .attr("class", "node")
  .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; })
.call(d3.behavior.drag()
  .origin(function (d) { return d; })
  .on("dragstart", function () { this.parentNode.appendChild(this); })
  .on("drag", dragmove));

node.append("rect")
  .attr("height", function (d) { return d.dy; })
  .attr("width", sankey.nodeWidth())
  .style("fill", function (d) { return d.color = color(d.name.replace(/ .*/, "")); })
  .style("stroke", function (d) { return d3.rgb(d.color).darker(2); })
.append("title")
  .text(function (d) { return d.name + "\n" + format(d.value); });

node.append("text")
  .attr("x", -6)
  .attr("y", function (d) { return d.dy / 2; })
  .attr("dy", ".35em")
  .attr("text-anchor", "end")
  .attr("transform", null)
  .text(function (d) { return d.name; })
.filter(function (d) { return d.x < params.width / 2; })
  .attr("x", 6 + sankey.nodeWidth())
  .attr("text-anchor", "start");

// the function for moving the nodes
  function dragmove(d) {
    d3.select(this).attr("transform", 
        "translate(" + (
                   d.x = Math.max(0, Math.min(params.width - d.dx, d3.event.x))
                ) + "," + (
                   d.y = Math.max(0, Math.min(params.height - d.dy, d3.event.y))
                ) + ")");
        sankey.relayout();
        link.attr("d", path);
  }
})();
</script>
    
    
                <script>
                var colors = {};
                d3.selectAll(' svg .node')[0].forEach(function(n) {
                type = n.getElementsByTagName('text')[0].innerHTML.replace(/[0-9]/g, '');
                if (typeof(colors[type]) == 'undefined') {
                colors[type] = n.getElementsByTagName('rect')[0].style.fill;
                } else {
                n.getElementsByTagName('rect')[0].style.fill = colors[type] ;
                };
                });
                
                d3.selectAll('svg path.link')
                .style('stroke', function(d){
                return d.source.color;
                })
                //.style('stroke-opacity', .7)
                </script>
                    
  </body>
</html>
